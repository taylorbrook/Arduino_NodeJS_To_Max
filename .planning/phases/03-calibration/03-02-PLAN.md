---
phase: 03-calibration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - max/sensor-pipeline.maxpat
autonomous: false

must_haves:
  truths:
    - "User can click a toggle button to start calibration, click again to stop and apply"
    - "User can click a reset button to clear all bias offsets and return to raw values"
    - "User can click a toggle to reset orientation to zero, click again to restore gravity frame"
    - "Progress bar advances while calibration samples are being collected"
    - "Bias offset values are displayed after calibration is applied"
    - "Calibration status text updates to show idle/collecting/applied states"
    - "Calibrated accel/gyro/orientation values display in separate flonum groups from raw"
    - "Orientation reset status message appears alongside smooth value transition"
  artifacts:
    - path: "max/sensor-pipeline.maxpat"
      provides: "Calibration UI controls, progress bar, bias display, calibrated data display"
      contains: "cal_accel"
  key_links:
    - from: "textbutton (Calibrate toggle)"
      to: "node.script inlet"
      via: "select 1 0 -> message calibrate_start/calibrate_stop"
      pattern: "calibrate_start"
    - from: "textbutton (Reset Calibration)"
      to: "node.script inlet"
      via: "message calibrate_reset"
      pattern: "calibrate_reset"
    - from: "textbutton (Reset Orientation toggle)"
      to: "node.script inlet"
      via: "select 1 0 -> message orient_reset/orient_restore"
      pattern: "orient_reset"
    - from: "route cal_progress"
      to: "slider (progress bar)"
      via: "unpack i i -> slider"
      pattern: "cal_progress"
    - from: "route cal_bias"
      to: "message box (bias display)"
      via: "unpack f f f f f f -> sprintf"
      pattern: "cal_bias"
    - from: "route cal_accel"
      to: "unpack f f f -> flonum display"
      via: "calibrated accel routing"
      pattern: "cal_accel"
---

<objective>
Extend the MAX patch with calibration controls, calibrated data display, progress bar, and bias offset display. Then verify the complete calibration flow end-to-end with physical hardware.

Purpose: This connects the calibration logic (from Plan 01) to interactive UI controls the user operates during live performance. After this plan, the user can calibrate sensors and reset orientation entirely from MAX.

Output: Updated sensor-pipeline.maxpat with calibration section containing: toggle buttons for calibrate start/stop and orientation reset/restore, bang button for calibration reset, progress slider, bias display, calibration status text, and 9 new flonum displays for calibrated accel/gyro/orientation data.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calibration/03-CONTEXT.md
@.planning/phases/03-calibration/03-RESEARCH.md
@.planning/phases/03-calibration/03-01-SUMMARY.md
@node/serial-bridge.js
@max/sensor-pipeline.maxpat
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend MAX patch with calibration UI and calibrated data routing</name>
  <files>max/sensor-pipeline.maxpat</files>
  <action>
Modify sensor-pipeline.maxpat JSON to add calibration controls and calibrated data display. The existing patch has boxes and lines arrays in a patcher object. Add new objects and connections.

**Step 1: Expand the route object.** Change the existing route object (obj-route) text from:
`"route accel gyro orientation status"`
to:
`"route accel gyro orientation status cal_accel cal_gyro cal_orientation cal_status cal_progress cal_bias"`
Update numinlets and numoutlets to 11 (10 route targets + 1 unmatched). Update outlettype to have 11 "" entries.

**Step 2: Add calibration control buttons.** Position below the existing controls area, around Y=420 to create a clear "Calibration" section.

Add a section header comment:
- obj-comment-cal-section: comment "Calibration Controls" at [60, 420], fontface 1, fontsize 13

Add Calibrate toggle button (textbutton):
- obj-btn-calibrate: textbutton, mode 1, text "Calibrate", texton "Stop & Apply", at [60, 450, 120, 30]
  Output: 0 or 1

Add select object to route toggle state:
- obj-sel-cal: newobj "select 1 0" at [60, 490]

Add message objects for calibrate commands:
- obj-msg-calstart: message "calibrate_start" at [60, 520]
- obj-msg-calstop: message "calibrate_stop" at [160, 520]

Wire: obj-btn-calibrate -> obj-sel-cal -> (outlet 0) obj-msg-calstart, (outlet 1) obj-msg-calstop
Wire: obj-msg-calstart -> obj-nodescript inlet 0
Wire: obj-msg-calstop -> obj-nodescript inlet 0

Add Reset Calibration button (textbutton, bang mode):
- obj-btn-calreset: textbutton, mode 0, text "Reset Cal" at [200, 450, 100, 30]
- obj-msg-calreset: message "calibrate_reset" at [200, 490]

Wire: obj-btn-calreset -> obj-msg-calreset -> obj-nodescript inlet 0

Add Orientation Reset toggle (textbutton):
- obj-btn-orient: textbutton, mode 1, text "Reset Orient", texton "Restore Frame" at [320, 450, 130, 30]
- obj-sel-orient: newobj "select 1 0" at [320, 490]
- obj-msg-orientreset: message "orient_reset" at [320, 520]
- obj-msg-orientrestore: message "orient_restore" at [420, 520]

Wire: obj-btn-orient -> obj-sel-orient -> (outlet 0) obj-msg-orientreset, (outlet 1) obj-msg-orientrestore
Wire: obj-msg-orientreset -> obj-nodescript inlet 0
Wire: obj-msg-orientrestore -> obj-nodescript inlet 0

**Step 3: Add progress bar.** Position near calibration controls.

- obj-comment-progress: comment "Calibration Progress" at [500, 420], fontface 1, fontsize 13
- obj-unpack-progress: newobj "unpack i i" at [500, 456] -- receives from route cal_progress outlet
- obj-slider-progress: slider, orientation 1 (horizontal), size [200, 20], at [500, 486], min 0, max 200

Wire: route outlet 8 (cal_progress, 0-indexed) -> obj-unpack-progress
Wire: obj-unpack-progress outlet 0 -> obj-slider-progress

**Step 4: Add calibration status display.**

- obj-comment-calstatus: comment "Cal Status" at [500, 520], fontface 1, fontsize 13
- obj-cal-status-display: message at [500, 546, 150, 22], text "idle"

Wire: route outlet 7 (cal_status, 0-indexed) -> obj-cal-status-display inlet 1 (right inlet for set)

**Step 5: Add bias offset display.**

- obj-comment-bias: comment "Bias Offsets" at [60, 560], fontface 1, fontsize 13
- obj-unpack-bias: newobj "unpack f f f f f f" at [60, 586]
- obj-sprintf-bias: newobj "sprintf aX:%.2f aY:%.2f aZ:%.2f gX:%.2f gY:%.2f gZ:%.2f" at [60, 616]
- obj-bias-display: message at [60, 646, 400, 22], text ""

Wire: route outlet 9 (cal_bias, 0-indexed) -> obj-unpack-bias
Wire: obj-unpack-bias all 6 outlets -> obj-sprintf-bias (outlets 0-5 to inlets 0-5)
Wire: obj-sprintf-bias -> obj-bias-display inlet 1 (right inlet for set, so text persists)

**Step 6: Add calibrated data display section.** Position below the raw data display, around Y=660.

Add section header:
- obj-comment-cal-data: comment "Calibrated Data" at [60, 670], fontface 1, fontsize 13

Calibrated Accelerometer (3 flonum):
- obj-comment-calaccel: comment "Cal Accel (g)" at [60, 700], fontface 1, fontsize 13
- obj-unpack-calaccel: newobj "unpack f f f" at [60, 726]
- obj-comment-cal-ax/ay/az and obj-flonum-cal-ax/ay/az at Y=756 and Y=776 (same pattern as raw accel, spaced 70px apart starting at X=60)

Wire: route outlet 4 (cal_accel, 0-indexed) -> obj-unpack-calaccel -> 3 flonums

Calibrated Gyroscope (3 flonum):
- obj-comment-calgyro: comment "Cal Gyro (dps)" at [310, 700], fontface 1, fontsize 13
- obj-unpack-calgyro: newobj "unpack f f f" at [310, 726]
- obj-flonum-cal-gx/gy/gz at Y=776 (same pattern as raw gyro)

Wire: route outlet 5 (cal_gyro, 0-indexed) -> obj-unpack-calgyro -> 3 flonums

Calibrated Orientation (3 flonum):
- obj-comment-calorient: comment "Cal Orient (deg)" at [597, 700], fontface 1, fontsize 13
- obj-unpack-calorient: newobj "unpack f f f" at [597, 726]
- obj-flonum-cal-pitch/roll/yaw at Y=776 (same pattern as raw orientation)

Wire: route outlet 6 (cal_orientation, 0-indexed) -> obj-unpack-calorient -> 3 flonums

**Important route outlet index mapping (0-indexed):**
- 0: accel (existing)
- 1: gyro (existing)
- 2: orientation (existing)
- 3: status (existing)
- 4: cal_accel (new)
- 5: cal_gyro (new)
- 6: cal_orientation (new)
- 7: cal_status (new)
- 8: cal_progress (new)
- 9: cal_bias (new)
- 10: unmatched (new, unused)

**Resize the patch window** to accommodate the new content. Update the patcher rect height from 800 to approximately 1050 to fit all new elements.

Preserve ALL existing boxes and lines. Only add new objects and connections. Keep existing object IDs unchanged.
  </action>
  <verify>
Read the modified sensor-pipeline.maxpat JSON and verify:
1. Route object text includes all 10 tags (accel gyro orientation status cal_accel cal_gyro cal_orientation cal_status cal_progress cal_bias)
2. Three textbutton objects exist (Calibrate toggle, Reset Cal bang, Reset Orient toggle)
3. Message objects for all 5 control commands exist and wire to node.script inlet
4. Slider object exists for progress bar
5. Cal status message box exists
6. Bias display chain: unpack -> sprintf -> message exists
7. 9 new flonum displays for calibrated data exist
8. All existing Phase 2 objects and connections are preserved
9. JSON is valid (parseable)
  </verify>
  <done>sensor-pipeline.maxpat contains calibration controls (3 buttons), progress bar, status display, bias offset display, and 9 calibrated data flonums. All wired to route outlets and node.script inlet. All existing Phase 2 objects and wiring preserved.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete calibration flow with physical hardware</name>
  <files>max/sensor-pipeline.maxpat</files>
  <action>
Human verification of the complete calibration system end-to-end. This checkpoint verifies Plan 01 (Node calibration logic) + Plan 02 Task 1 (MAX patch UI) working together with physical hardware.

**Setup:** Connect Arduino Uno WiFi R2 via USB. Open max/sensor-pipeline.maxpat in MAX. Verify node.script auto-starts and connects (status shows "connected", raw data flowing).

**Test 1: Calibration flow (CALB-01, CALB-02, CALB-06)**
1. Place the board flat and still on a table
2. Note the raw gyro values (should be small but non-zero due to bias)
3. Click "Calibrate" button -- it should change to "Stop and Apply"
4. Verify: cal status shows "collecting", progress bar advances toward 200
5. Wait ~2 seconds (200 samples at 114 Hz)
6. Click "Stop and Apply" -- it should change back to "Calibrate"
7. Verify: cal status shows "applied"
8. Verify: bias offset values appear (e.g. "aX:-0.02 aY:0.01 aZ:0.03 gX:-0.42 gY:0.18 gZ:-0.11")
9. Verify: calibrated gyro values in the "Cal Gyro" section are closer to zero than the raw gyro values
10. Verify: calibrated accel Z shows ~1.0 when flat (raw may show ~0.97 or ~1.03)

**Test 2: Calibration persistence (CALB-02)**
11. Move the board around -- calibrated values should stay corrected
12. Return board to flat -- calibrated values return to near zero (gyro) and 0,0,1 (accel)

**Test 3: Reset calibration (CALB-03, CALB-04)**
13. Click "Reset Cal" button
14. Verify: cal status returns to "idle"
15. Verify: calibrated data flonums stop updating (no calibrated outlets when uncalibrated)
16. Verify: bias display clears or stays showing last values

**Test 4: Orientation reset (CALB-05 expanded to all axes)**
17. First re-calibrate (repeat steps 3-6 for clean data)
18. Hold the board at an angle (e.g. tilted 30 degrees pitch, 15 degrees roll, arbitrary yaw)
19. Click "Reset Orient" -- it should change to "Restore Frame"
20. Verify: cal status briefly shows "orient_reset"
21. Verify: calibrated orientation values SMOOTHLY transition toward 0,0,0 (not instant snap)
22. Verify: after ~0.5 seconds, cal orientation shows approximately 0,0,0
23. Tilt the board further -- cal orientation should track relative to new zero

**Test 5: Restore original frame**
24. Click "Restore Frame" -- it should change back to "Reset Orient"
25. Verify: cal status briefly shows "orient_restored"
26. Verify: calibrated orientation values smoothly transition back to gravity-referenced values
27. Return board to flat -- cal orientation should show approximately 0,0,(some yaw)

**Test 6: Edge case -- calibration reset clears orientation offset**
28. Reset orientation (step 19)
29. Click "Reset Cal"
30. Verify: orientation reset is also cleared (cal orientation, if displayed, shows gravity-referenced values again)
  </action>
  <verify>User confirms all 6 test groups pass (30 verification steps). Type "approved" or describe which test failed and what was observed.</verify>
  <done>Complete calibration system verified end-to-end with physical hardware: bias calibration, orientation reset with smooth transition, visual feedback, reset behavior, and cross-system interaction (cal reset clears orient offset).</done>
</task>

</tasks>

<verification>
Phase 3 success criteria from ROADMAP.md:
1. User can trigger calibration from MAX (toggle on, hold still, toggle off) and see gyro drift visibly reduced -- Tests 1-2
2. Calibration bias offsets persist across readings until explicitly reset -- Test 2
3. User can reset calibration to uncalibrated state from MAX and see raw uncorrected values resume -- Test 3
4. User can reset yaw to zero from MAX at any time and see yaw snap to zero then track from new reference -- Tests 4-5 (expanded to all axes per user decision, smooth not snap)
5. MAX shows visual feedback during calibration (status text or indicator) -- Tests 1 (progress bar + status text)
</verification>

<success_criteria>
- sensor-pipeline.maxpat has 3 calibration control buttons wired to node.script
- Progress bar responds to cal_progress messages during calibration
- Status text shows idle/collecting/applied/orient_reset/orient_restored states
- Bias offset values displayed after calibration applied
- 9 calibrated data flonums display corrected values
- All Phase 2 raw data display continues working alongside calibrated display
- User approves end-to-end verification with physical hardware
</success_criteria>

<output>
After completion, create `.planning/phases/03-calibration/03-02-SUMMARY.md`
</output>
