---
phase: 07-core-engine-and-predefined-gestures
plan: 03
type: execute
wave: 3
depends_on:
  - 07-02
files_modified:
  - max/imu-gesture.maxpat
autonomous: false
requirements:
  - IMPL-01

must_haves:
  truths:
    - "User can open imu-gesture.maxpat, select a serial port, click connect, and receive gesture bang events from physical device motion"
    - "User can see 7 gesture rows with toggle, sensitivity dial, cooldown dial, and fire LED per gesture type"
    - "User can enable/disable individual gestures and see only enabled gestures produce output"
    - "User can adjust sensitivity and cooldown dials and see detection behavior change"
    - "Gesture event outlet outputs named messages (shake, tap, flip, tilt-left, etc.) suitable for downstream route object"
    - "Sensor data outlets provide smoothed accel, gyro, orientation data identical to imu-sensor"
    - "All dial and toggle positions persist when the patch is saved and reopened"
  artifacts:
    - path: "max/imu-gesture.maxpat"
      provides: "Self-contained gesture detection MAX abstraction wrapping gesture-engine.js"
      min_lines: 100
  key_links:
    - from: "max/imu-gesture.maxpat"
      to: "max/gesture-engine.js"
      via: "node.script gesture-engine.js @autostart 1"
      pattern: "node.script.*gesture-engine"
    - from: "max/imu-gesture.maxpat (UI toggles/dials)"
      to: "max/gesture-engine.js (handlers)"
      via: "prepend gesture_enable/gesture_sensitivity/gesture_cooldown -> node.script inlet"
      pattern: "gesture_enable|gesture_sensitivity|gesture_cooldown"
    - from: "max/imu-gesture.maxpat (route)"
      to: "max/imu-gesture.maxpat (outlets)"
      via: "route gesture engine_status smooth_accel smooth_gyro smooth_orientation status"
      pattern: "route.*gesture.*smooth"
---

<objective>
Create the imu-gesture.maxpat MAX abstraction that wraps gesture-engine.js with a clean user interface: minimal sensor controls (port selector + connect), 7 gesture configuration rows, and properly routed outlets for gesture events, status, and sensor data.

Purpose: Provides the user-facing MAX patch that makes gesture detection accessible without any code -- just drop the abstraction, connect Arduino, and receive gesture events.

Output: `max/imu-gesture.maxpat` -- a complete MAX abstraction with node.script integration, per-gesture UI rows, and multi-outlet interface.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-core-engine-and-predefined-gestures/07-CONTEXT.md
@.planning/phases/07-core-engine-and-predefined-gestures/07-RESEARCH.md
@.planning/phases/07-core-engine-and-predefined-gestures/07-01-SUMMARY.md
@.planning/phases/07-core-engine-and-predefined-gestures/07-02-SUMMARY.md
@max/gesture-engine.js
@max/imu-sensor.maxpat
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create imu-gesture.maxpat with node.script, routing, UI, and outlets</name>
  <files>max/imu-gesture.maxpat</files>
  <action>
Create `max/imu-gesture.maxpat` as a MAX patch JSON file. Reference `max/imu-sensor.maxpat` for the JSON structure conventions (patcher format, box definitions, line connections). The patch should be structured as follows:

**Core node.script integration:**
- `node.script gesture-engine.js @autostart 1` -- central object, loads gesture-engine.js
- Use `@defer 1` if the existing imu-sensor.maxpat uses it (check the reference)
- Left outlet carries all tagged messages; right outlet is lifecycle

**Main route object:**
- Connected to node.script left outlet
- Routes: `gesture gesture_led engine_status smooth_accel smooth_gyro smooth_orientation cal_accel cal_gyro cal_orientation norm_accel norm_gyro norm_orientation status cal_status cal_progress cal_bias cal_toggle`
- Each route output connects to the appropriate destination (outlets or internal UI)

**Minimal sensor controls (top section of patch):**
- Port selector: `umenu` populated by `route status` output showing available ports (or manual port entry via message box)
- Connect/Disconnect: two message boxes (`connect`, `disconnect`) connected to node.script inlet
- Connection status: message box showing current status (connected-usb, scanning, etc.)
- Activity LED: small `led` or `panel` object driven by `engine_status` route output (active=green, idle=off)
- Auto-calibrate: `deferlow` after `status connected-usb` triggers `calibrate_start` message to node.script (500ms delay using `delay 500` after status match, same pattern as imu-sensor.maxpat)

**7 gesture configuration rows (main section):**
Each row for gesture types: shake, tap, flip, tilt-left, tilt-right, tilt-forward, tilt-back.

Each row contains:
1. **Label:** `comment` object with gesture name (e.g., "shake", "tap", "flip", "tilt-left")
2. **Enable toggle:** `toggle @save 1` -> `prepend gesture_enable <name>` -> node.script inlet
   - Default: on (toggle value 1)
   - `@save 1` ensures persistence when patch is saved
3. **Sensitivity dial:** `dial @size 1. @floatoutput 1 @save 1` (range 0.0-1.0) -> `prepend gesture_sensitivity <name>` -> node.script inlet
   - Default position: 0.5 (middle)
   - Label above: "sensitivity"
4. **Cooldown dial:** `dial @floatoutput 1 @save 1` with appropriate size per gesture type:
   - shake: `@size 1000.` (0-1000ms range)
   - tap: `@size 500.` (0-500ms range)
   - flip: `@size 2000.` (0-2000ms range)
   - tilts: `@size 1000.` (0-1000ms range)
   - -> `prepend gesture_cooldown <name>` -> node.script inlet
   - Default positions: shake=300, tap=200, flip=800, tilts=400
   - Label above: "cooldown (ms)"
5. **Fire LED:** `led` object driven by `gesture_led` route output
   - Route `gesture_led` output through `route shake tap flip tilt-left tilt-right tilt-forward tilt-back` to split LED signals per gesture
   - Each LED turns on when gesture fires, auto-off after 100ms (handled in gesture-engine.js)

**Initialization chain:**
- `loadbang` -> `deferlow` -> send initial dial/toggle values to node.script
- This ensures node.script is ready before receiving configuration messages
- Each toggle and dial should send its stored value on load so gesture-engine.js receives the persisted state
- Pattern: `loadbang -> deferlow -> t b b b... -> each trigger sends the stored UI value`
- OR use `autopattr` to auto-restore named UI objects (simpler if many objects)

**Outlets (bottom of patch):**
The abstraction needs these outlets in order:
- Outlet 0: Gesture events (from `route gesture` output) -- named symbols: shake, tap, flip, tilt-left, etc.
- Outlet 1: Engine status (from `route engine_status`) -- "active" or "idle"
- Outlet 2: Smooth accel (from `route smooth_accel`) -- 3 floats
- Outlet 3: Smooth gyro (from `route smooth_gyro`) -- 3 floats
- Outlet 4: Smooth orientation (from `route smooth_orientation`) -- 3 floats
- Outlet 5: Connection status (from `route status`) -- status symbols
- Outlet 6: Calibration status (from `route cal_status`) -- cal state symbols

**Inlet:**
- Inlet 0: Control messages (connect, disconnect, transport, calibrate_start, etc.) routed to node.script inlet

**Layout guidelines:**
- Top section: connection controls (port, connect/disconnect, status, activity LED) -- compact, minimal
- Middle section: 7 gesture rows laid out vertically, each row ~30px tall
- Bottom section: outlet objects in a horizontal row
- Total patch size: approximately 800x700 pixels
- Use `comment` objects for section headers and labels
- Reference imu-sensor.maxpat for color scheme and general aesthetic

**MAX patch JSON conventions (from imu-sensor.maxpat):**
- Use `"maxclass"` for each object type
- Use `"patching_rect"` for [x, y, width, height] positioning
- Use `"patchlines"` array for connections
- Use `"numinlets"` and `"numoutlets"` correctly
- Set `@save 1` via `"saved_attribute_attributes"` or `"parameter_enable": 1` in JSON
- For `dial` with float output: set `"floatoutput": 1` and `"size": <max_value>`
- For `toggle`: just set the `"int"` value for default state

**CRITICAL persistence notes (from Pitfall 5 in research):**
- Every dial and toggle MUST have persistence enabled so values survive save/reopen
- Method: Use `"parameter_enable": 1` and `"saved_attribute_attributes"` with `"valueof"` parameter settings in the dial/toggle JSON definition
- Alternative: Use `autopattr` object with `@autoname 1` to capture all named UI objects
- The `@save 1` approach is simpler -- each dial/toggle gets `"parameter_enable": 1` in its JSON
- Test by checking that the JSON includes parameter storage attributes on all UI objects
  </action>
  <verify>
1. Verify `max/imu-gesture.maxpat` is valid JSON: `python3 -c "import json; json.load(open('max/imu-gesture.maxpat'))"`
2. Verify node.script reference: search for "gesture-engine.js" in the JSON
3. Verify 7 gesture rows: search for all 7 gesture names (shake, tap, flip, tilt-left, tilt-right, tilt-forward, tilt-back) in the JSON
4. Verify outlet count: search for outlet objects (should be at least 7)
5. Verify persistence: search for "parameter_enable" or "save" attributes on UI objects
6. Verify route object: search for route arguments including "gesture" and "smooth_accel"
7. Verify gesture handler messages: search for "gesture_enable", "gesture_sensitivity", "gesture_cooldown" prepend objects
  </verify>
  <done>
imu-gesture.maxpat exists as valid MAX patch JSON containing: node.script loading gesture-engine.js with @autostart 1, main route object splitting all tagged outlets, minimal sensor UI (port selector + connect + status + activity LED), 7 gesture rows each with enable toggle + sensitivity dial + cooldown dial + fire LED, auto-calibration on connect, 7 abstraction outlets (gestures + status + sensor data), and parameter persistence on all UI objects.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify gesture detection with physical hardware</name>
  <files>max/imu-gesture.maxpat</files>
  <action>
Human verification of complete gesture detection system. What was built: imu-gesture.maxpat wrapping gesture-engine.js with 7 predefined gesture detectors (shake, tap, flip, tilt-left, tilt-right, tilt-forward, tilt-back), per-gesture enable/disable toggles, sensitivity dials, cooldown dials, and fire LED indicators.

Steps to verify:
1. Open `max/imu-gesture.maxpat` in MAX 8 or MAX 9
2. Verify the patch loads without errors in the MAX console (no "module not found" or node.script errors)
3. Connect Arduino via USB -- verify auto-connection (status shows "connected-usb") and auto-calibration fires
4. Verify sensor data outlets are active (connect flonum objects to smooth accel/gyro/orientation outlets)
5. Test shake: Shake the Arduino device vigorously -- verify "shake" LED blinks and gesture outlet outputs "shake"
6. Test tap: Tap the Arduino firmly -- verify "tap" LED blinks and gesture outlet outputs "tap"
7. Test flip: Turn the Arduino upside-down -- verify "flip" LED blinks and gesture outlet outputs "flip"
8. Test tilts: Tilt the Arduino left, right, forward, back -- verify corresponding tilt LEDs blink and gesture outlet outputs the correct name
9. Test enable/disable: Turn off the shake toggle, shake the device -- verify NO shake event fires. Re-enable and verify shake works again.
10. Test sensitivity: Lower shake sensitivity dial toward 0.0 (very sensitive) -- verify lighter shakes trigger. Raise toward 1.0 (insensitive) -- verify only hard shakes trigger.
11. Test persistence: Adjust some dials, save the patch (Cmd+S), close and reopen -- verify dial positions were restored.
12. Test idle/active: Leave device stationary for >1 second -- verify no false gesture triggers. Then move the device -- verify gestures detect normally.
13. Connect a `route shake tap flip tilt-left tilt-right tilt-forward tilt-back` to the gesture outlet to verify downstream routing works.

Common issues to watch for:
- False triggers while device is stationary (activity gate not working)
- Tilt firing continuously while held at an angle (hysteresis not working)
- Missing module errors (node_modules symlink issue)
- Dials not sending values on patch load (initialization chain issue)

Resume signal: Type "approved" if gesture detection works correctly, or describe any issues found (e.g., "shake too sensitive", "tilt fires continuously", "no connection")
  </action>
  <verify>User confirms all 7 gesture types detect correctly, enable/disable works, sensitivity adjustment changes behavior, and no false triggers occur at rest.</verify>
  <done>All 7 predefined gestures detect reliably with physical hardware, per-gesture controls function correctly, sensor data outlets provide smoothed data, and UI state persists across save/reopen.</done>
</task>

</tasks>

<verification>
- imu-gesture.maxpat is valid JSON and loads in MAX without errors
- node.script successfully starts gesture-engine.js
- All 7 gesture types detect correctly with physical hardware
- Per-gesture enable/disable, sensitivity, and cooldown controls work
- Sensor data outlets provide smoothed data (superset of imu-sensor)
- UI state persists across save/reopen
- No false triggers when device is stationary
</verification>

<success_criteria>
- User can open imu-gesture.maxpat, connect Arduino, and receive gesture events without modifying any existing v1.0 files
- All 7 predefined gestures detect reliably with sensible defaults
- Per-gesture controls (enable, sensitivity, cooldown) work and persist
- Sensor data outlets match imu-sensor behavior (superset compatibility)
- Activity gate prevents false triggers during stillness
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-engine-and-predefined-gestures/07-03-SUMMARY.md`
</output>
