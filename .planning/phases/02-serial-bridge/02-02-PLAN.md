---
phase: 02-serial-bridge
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - max/sensor-pipeline.maxpat
autonomous: false

must_haves:
  truths:
    - "MAX patch loads node.script with serial-bridge.js and auto-starts it"
    - "Live sensor values (accel, gyro, orientation) display in MAX and update in real time"
    - "Connection status (disconnected/scanning/connected) is visible in the MAX patch"
    - "Unplugging and re-plugging Arduino recovers data flow without restarting MAX"
    - "Malformed serial lines never produce NaN or errors in the MAX display"
  artifacts:
    - path: "max/sensor-pipeline.maxpat"
      provides: "MAX patch with node.script, route, unpack, and number display objects"
      contains: "node.script"
  key_links:
    - from: "max/sensor-pipeline.maxpat"
      to: "node/serial-bridge.js"
      via: "node.script object referencing ../node/serial-bridge.js"
      pattern: "serial-bridge.js"
    - from: "max/sensor-pipeline.maxpat"
      to: "route object"
      via: "route accel gyro orientation status"
      pattern: "route"
---

<objective>
Create the MAX patch that wires up the Node for Max serial bridge script, routes tagged sensor data into separate display streams, and shows connection status -- completing the end-to-end Arduino-to-MAX pipeline.

Purpose: Without the MAX patch, the Node script has nowhere to output data. This plan makes sensor data visible and usable in MAX.
Output: max/sensor-pipeline.maxpat (complete MAX patch file)
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-serial-bridge/02-RESEARCH.md
@.planning/phases/02-serial-bridge/02-01-SUMMARY.md
@node/serial-bridge.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MAX patch with node.script, routing, and display</name>
  <files>max/sensor-pipeline.maxpat</files>
  <action>
Create the `max/` directory at the project root (alongside `firmware/` and `node/`).

Create `max/sensor-pipeline.maxpat` as a valid MAX JSON patch file. MAX patches are JSON files with a specific structure. The patch must contain:

**node.script object:**
- Object: `node.script` with argument `../node/serial-bridge.js`
- Attribute: `@autostart 1` (script starts when patch opens)
- Position: top-center of the patch

**node.debug object:**
- Connected to the RIGHT outlet of node.script (lifecycle/debug messages)
- Shows Node console output in MAX window

**route object:**
- Connected to the LEFT outlet of node.script (data messages)
- Arguments: `route accel gyro orientation status`
- This splits tagged messages into 4 separate outlets (plus unmatched)

**Accelerometer display section:**
- Comment box: "Accelerometer (g)"
- `unpack f f f` connected to route's first outlet (accel)
- Three `flonum` (number box) objects labeled aX, aY, aZ
- Each flonum connected to corresponding unpack outlet

**Gyroscope display section:**
- Comment box: "Gyroscope (dps)"
- `unpack f f f` connected to route's second outlet (gyro)
- Three `flonum` objects labeled gX, gY, gZ

**Orientation display section:**
- Comment box: "Orientation (degrees)"
- `unpack f f f` connected to route's third outlet (orientation)
- Three `flonum` objects labeled Pitch, Roll, Yaw

**Status display section:**
- Comment box: "Connection Status"
- `message` object connected to route's fourth outlet (status)
- This displays the current state string (disconnected/scanning/connected)

**Control section:**
- `message` box containing "connect" -- sends connect message to node.script inlet
- `message` box containing "disconnect" -- sends disconnect message to node.script inlet
- `message` box containing "listports" -- sends listports message to node.script inlet
- `message` box containing "reset" -- sends reset command (forwarded to Arduino via serial)
- These message boxes connect to the inlet of node.script

**Patch layout:**
- Title comment at top: "Arduino IMU Serial Bridge"
- Control messages on the left
- node.script centered below controls
- route below node.script
- Three sensor sections arranged horizontally below route
- Status display below or beside sensor sections

**MAX patch JSON format:**
The .maxpat file is JSON with this structure:
```json
{
  "patcher": {
    "fileversion": 1,
    "appversion": { "major": 8, "minor": 6, "revision": 0, "architecture": "x64", "modernui": 1 },
    "classnamespace": "box",
    "rect": [100, 100, 900, 700],
    "gridsize": [15, 15],
    "boxes": [ ... ],
    "lines": [ ... ]
  }
}
```

Each box has:
```json
{
  "box": {
    "id": "obj-1",
    "maxclass": "newobj",  // or "comment", "message", "flonum"
    "text": "node.script ../node/serial-bridge.js @autostart 1",
    "numinlets": 1,
    "numoutlets": 2,
    "outlettype": ["", ""],
    "patching_rect": [x, y, width, height]
  }
}
```

Each patchline has:
```json
{
  "patchline": {
    "source": ["obj-1", 0],   // [object_id, outlet_index]
    "destination": ["obj-2", 0]  // [object_id, inlet_index]
  }
}
```

Key maxclass values:
- `"newobj"` for node.script, route, unpack
- `"comment"` for labels/titles
- `"message"` for clickable message boxes (connect, disconnect, etc.)
- `"flonum"` for number display boxes
- `"node.debug"` for the debug display (maxclass is "newobj", text is "node.debug")

Important details:
- node.script has 1 inlet and 2 outlets (left = data, right = lifecycle)
- route with 4 arguments has 5 outlets (4 matched + 1 unmatched)
- unpack f f f has 1 inlet and 3 outlets
- flonum has 1 inlet and 1 outlet
- message has 1 inlet and 1 outlet (clicking sends its content to connected object)
- Control message boxes connect TO node.script's inlet
- The script path `../node/serial-bridge.js` is relative to the max/ directory

Lay out objects with clear spacing. Use y-coordinates that flow top-to-bottom. Use x-coordinates that group related objects together horizontally.
  </action>
  <verify>Read max/sensor-pipeline.maxpat and confirm it is valid JSON containing: node.script with serial-bridge.js, route with accel/gyro/orientation/status, three unpack objects, flonum display objects, message boxes for connect/disconnect/listports/reset, and patchlines connecting them all</verify>
  <done>max/sensor-pipeline.maxpat is a complete, valid MAX patch that can be opened in MAX to display live sensor data from the Arduino via the Node serial bridge</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end pipeline in MAX</name>
  <files>max/sensor-pipeline.maxpat, node/serial-bridge.js</files>
  <action>
Present the user with the verification checklist below. This is a human-verify checkpoint -- the user must physically test the pipeline with hardware.

What was built:
- Node for Max serial bridge script (node/serial-bridge.js) that auto-discovers the Arduino, parses CSV data, validates it, and outputs tagged messages
- MAX patch (max/sensor-pipeline.maxpat) that displays live accelerometer, gyroscope, and orientation data with connection status
  </action>
  <verify>
User confirms all 12 verification steps pass:
1. Arduino Uno WiFi Rev2 is plugged in via USB (firmware from Phase 1 running)
2. Open max/sensor-pipeline.maxpat in MAX
3. node.script auto-starts (MAX console shows "[serial-bridge] status: scanning" then "connected")
4. Status display shows "connected"
5. 9 number boxes update with live values (accel near 0,0,1 when flat; gyro near 0 when still; pitch/roll near 0 when flat)
6. Tilting the board produces smooth pitch and roll response
7. Rotating the board produces yaw tracking
8. Unplug Arduino USB cable
9. Status changes to "disconnected" then "scanning"
10. Plug Arduino back in
11. Status returns to "connected" and data resumes (2-4 sec for discovery + reboot)
12. MAX console has no NaN errors or crash messages
  </verify>
  <done>User has confirmed the end-to-end pipeline works: live data displays, status reporting functions, and disconnect/reconnect recovery operates correctly</done>
</task>

</tasks>

<verification>
Phase 2 success criteria from ROADMAP.md:

1. MAX patch receives and displays live sensor values (raw 6-axis and orientation) updating in real time when Arduino is connected
   -> Verified by Task 2 steps 4-7

2. Malformed or incomplete serial lines are silently dropped -- no crashes, no NaN propagation into MAX
   -> Verified by validateLine() in serial-bridge.js + Task 2 step 12

3. Connection status is visible in MAX: user can see whether the port is detected, data is flowing, or the device is disconnected
   -> Verified by Task 2 steps 3-4, 9

4. Unplugging and re-plugging the Arduino causes the pipeline to recover automatically without restarting MAX or the Node script
   -> Verified by Task 2 steps 8-11
</verification>

<success_criteria>
- max/sensor-pipeline.maxpat opens in MAX without errors
- node.script auto-starts and connects to Arduino
- Live sensor data displays in number boxes
- Status indicator shows connection state
- Disconnect/reconnect cycle works without restarting MAX
- No NaN values appear in MAX display
</success_criteria>

<output>
After completion, create `.planning/phases/02-serial-bridge/02-02-SUMMARY.md`
</output>
