---
phase: 02-serial-bridge
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - node/serial-bridge.js
  - node/package.json
autonomous: true

must_haves:
  truths:
    - "Node script parses 9-value CSV lines from Arduino serial at 57600 baud"
    - "Malformed lines (wrong field count, NaN, STARTUP/ERROR headers) are silently dropped"
    - "Script outputs tagged messages (accel, gyro, orientation, status) via maxAPI.outlet()"
    - "Script detects Arduino port automatically via SerialPort.list()"
    - "Script recovers from USB disconnect by polling for port reappearance"
    - "Connection state machine reports disconnected/scanning/connected to MAX"
  artifacts:
    - path: "node/serial-bridge.js"
      provides: "Complete serial bridge with parsing, validation, state machine, reconnection"
      min_lines: 120
    - path: "node/package.json"
      provides: "npm manifest with serialport v12 dependency"
      contains: "serialport"
  key_links:
    - from: "node/serial-bridge.js"
      to: "serialport"
      via: "require('serialport')"
      pattern: "require.*serialport"
    - from: "node/serial-bridge.js"
      to: "max-api"
      via: "require('max-api')"
      pattern: "require.*max-api"
    - from: "node/serial-bridge.js"
      to: "Arduino CSV output"
      via: "ReadlineParser on serial port"
      pattern: "ReadlineParser"
---

<objective>
Create the Node for Max serial bridge script that receives Arduino IMU data over USB serial, validates CSV lines, and outputs parsed sensor streams via tagged maxAPI.outlet() messages with automatic connection management.

Purpose: This is the core data pipeline -- without this script, no sensor data reaches MAX.
Output: node/serial-bridge.js (complete bridge script), node/package.json (npm manifest)
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-serial-bridge/02-RESEARCH.md
@firmware/imu_firmware/imu_firmware.ino
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Node project and install serialport</name>
  <files>node/package.json</files>
  <action>
Create the `node/` directory at the project root (alongside `firmware/`).

Initialize npm: run `npm init -y` inside `node/`.

Then edit package.json to set:
- name: "aruido-serial-bridge"
- version: "1.0.0"
- description: "Node for Max serial bridge for Arduino IMU data"
- main: "serial-bridge.js"
- Remove the "test" script (or set to empty)

Install serialport v12: run `npm install serialport@12` inside `node/`.

Do NOT install max-api -- it is provided by MAX's runtime and must NOT be in package.json or node_modules.

Verify: package.json contains "serialport" in dependencies with version "^12.x.x". node_modules/serialport/ directory exists.
  </action>
  <verify>Check that node/package.json exists with serialport dependency; check that node/node_modules/serialport exists</verify>
  <done>node/package.json has serialport ^12.x dependency, node_modules installed, max-api is NOT listed as a dependency</done>
</task>

<task type="auto">
  <name>Task 2: Write complete serial bridge script</name>
  <files>node/serial-bridge.js</files>
  <action>
Create `node/serial-bridge.js` -- the complete serial bridge script for Node for Max.

The script must implement all of the following:

**Imports and Configuration:**
- `const maxAPI = require("max-api");` -- do NOT destructure, just use maxAPI directly
- `const { SerialPort } = require("serialport");`
- `const { ReadlineParser } = require("@serialport/parser-readline");`
- Constants: BAUD_RATE = 57600, EXPECTED_FIELDS = 9, RECONNECT_INTERVAL_MS = 2000
- State variables: port (null), parser (null), reconnectTimer (null), state ("disconnected")

**Connection State Machine:**
- States: "disconnected", "scanning", "connected"
- `updateStatus(newState)` function that sets state and calls `maxAPI.outlet("status", state)` and `maxAPI.post("[serial-bridge] status: " + state)`

**Port Discovery:**
- `findArduinoPort()` async function that calls `SerialPort.list()` and finds the Arduino by matching:
  - `p.vendorId === "2341"` (Arduino vendor ID) OR
  - `p.path.includes("usbmodem")` OR `p.path.includes("ttyACM")`
- Returns the port info object or null

**CSV Validation (SERL-02):**
- `validateLine(line)` function:
  - If line starts with "STARTUP" or "ERROR", log to MAX console via `maxAPI.post("[arduino] " + line)` and return null
  - Split on comma, check length === 9, return null if wrong count
  - Map to Number, check `.some(isNaN)`, return null if any NaN
  - Return the 9-element array of numbers on success
  - All drops are SILENT (no error output to MAX outlets, only maxAPI.post for STARTUP/ERROR lines)

**Data Output (SERL-03):**
- `outputData(values)` function:
  - Destructure: `[ax, ay, az, gx, gy, gz, pitch, roll, yaw] = values`
  - Call exactly 3 outlet calls per sample:
    - `maxAPI.outlet("accel", ax, ay, az)`
    - `maxAPI.outlet("gyro", gx, gy, gz)`
    - `maxAPI.outlet("orientation", pitch, roll, yaw)`
  - 3 calls per sample at 114 Hz = 342 calls/sec -- well within safe range

**Connection (SERL-01):**
- `connectToPort(portPath)` function:
  - Create SerialPort with `{ path: portPath, baudRate: BAUD_RATE, autoOpen: false }`
  - Pipe through `new ReadlineParser({ delimiter: "\n" })`
  - Attach port.on("open") -> updateStatus("connected")
  - Attach port.on("error") -> maxAPI.post the error message
  - Attach port.on("close") -> cleanup(), updateStatus("disconnected"), startScanning()
  - Attach parser.on("data") -> trim line, validateLine, if valid call outputData
  - Call port.open(callback) -- on error: maxAPI.post, cleanup(), startScanning()

**Cleanup:**
- `cleanup()` function:
  - Remove all listeners from parser and port
  - If port.isOpen, call port.close()
  - Set port = null, parser = null

**Reconnection (SERL-05):**
- `startScanning()` async function:
  - If reconnectTimer already set, return (prevent multiple timers)
  - updateStatus("scanning")
  - Set reconnectTimer = setInterval(async () => { ... }, RECONNECT_INTERVAL_MS)
  - Inside interval: call findArduinoPort(), if found: clearInterval, set reconnectTimer = null, call connectToPort(found.path)
  - Wrap in try/catch, log errors via maxAPI.post

**MAX Message Handlers:**
- `maxAPI.addHandler("connect", (portPath) => { ... })` -- if portPath provided, connect directly; otherwise startScanning()
- `maxAPI.addHandler("disconnect", () => { ... })` -- clear reconnectTimer, cleanup, updateStatus("disconnected")
- `maxAPI.addHandler("listports", async () => { ... })` -- list all ports via maxAPI.post
- `maxAPI.addHandler("reset", () => { ... })` -- if port is open, write "R" to send reset command to Arduino firmware

**Auto-start:**
- At module level, call `startScanning()` so the script begins port discovery immediately when loaded by node.script with @autostart 1

**Important implementation details:**
- Use `port.removeAllListeners()` in cleanup to prevent memory leaks on reconnection cycles
- The `close` event on macOS fires when USB is unplugged -- old port instance is dead, must create fresh one
- Do NOT use try/catch around maxAPI.outlet() -- it is synchronous and does not throw
- Trim incoming lines before validation (ReadlineParser may leave trailing \r from Arduino's println)
  </action>
  <verify>Read the file and confirm it contains: require("max-api"), require("serialport"), ReadlineParser, validateLine function with field count and NaN checks, connectToPort function, startScanning function, maxAPI.outlet calls for accel/gyro/orientation/status, maxAPI.addHandler for connect/disconnect/listports/reset</verify>
  <done>serial-bridge.js is a complete, self-contained Node for Max script implementing serial reception, CSV validation, tagged outlet output, connection state machine with auto-reconnect, and MAX message handlers</done>
</task>

</tasks>

<verification>
Phase-level checks after all tasks complete:

1. `node/package.json` exists with serialport dependency
2. `node/serial-bridge.js` exists with 120+ lines
3. Script requires max-api (not installed, runtime-provided)
4. Script requires serialport and ReadlineParser
5. validateLine handles: STARTUP/ERROR lines (logs, returns null), wrong field count (returns null), NaN values (returns null), valid 9-field CSV (returns number array)
6. outputData calls maxAPI.outlet with tags: accel, gyro, orientation
7. updateStatus calls maxAPI.outlet with tag: status
8. connectToPort handles open, error, close events
9. startScanning polls via setInterval + SerialPort.list()
10. cleanup destroys old port instance completely
11. Auto-start: startScanning() called at module level
</verification>

<success_criteria>
- node/package.json exists with serialport ^12.x dependency
- node/serial-bridge.js is a complete bridge script (120+ lines)
- Script handles the full connection lifecycle: scan -> connect -> receive -> validate -> output -> disconnect -> scan
- CSV validation drops malformed lines silently
- Tagged outlet messages match the routing pattern needed by Plan 02's MAX patch
</success_criteria>

<output>
After completion, create `.planning/phases/02-serial-bridge/02-01-SUMMARY.md`
</output>
