---
phase: 04-musical-tools
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - max/sensor-pipeline.maxpat
autonomous: true

must_haves:
  truths:
    - "User can map any sensor axis from its input range to an arbitrary output range"
    - "User can choose linear, exponential, or custom curve for each axis mapping"
    - "User can capture input range by moving the board (learn mode) or type values manually"
    - "User can toggle clipping per axis to constrain or allow output overflow"
  artifacts:
    - path: "max/sensor-pipeline.maxpat"
      provides: "Per-axis range mapping with 3 curve types, learn mode, and clip toggle"
      contains: "scale"
  key_links:
    - from: "smoothed sensor values (via receive)"
      to: "scale/function objects"
      via: "gate selects curve type -> scale (linear/exp) or function (custom)"
      pattern: "gate"
    - from: "learn button"
      to: "maximum/minimum objects"
      via: "clear on learn start, track during learn, populate fields on stop"
      pattern: "maximum"
    - from: "clip toggle"
      to: "clip object"
      via: "gate bypasses or applies clip"
      pattern: "clip"
---

<objective>
Add per-axis range mapping module with three curve types, learn mode, and clip toggle to the MAX patch.

Purpose: Range mapping (MAXI-02) transforms smoothed sensor values into musically useful parameter ranges. This is the core creative tool -- it converts raw sensor ranges (e.g., pitch 0-90 degrees) into arbitrary output ranges (e.g., frequency 200-2000 Hz) with configurable response curves. Learn mode lets the user capture their actual movement range by waving the board.

Output: sensor-pipeline.maxpat extended with per-axis mapping modules: each axis gets input range (min/max with learn mode), curve type selector (linear/exponential/custom), output range (min/max), clip toggle, and mapped output display.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-musical-tools/04-RESEARCH.md
@.planning/phases/04-musical-tools/04-CONTEXT.md
@.planning/phases/04-musical-tools/04-01-SUMMARY.md
@max/sensor-pipeline.maxpat
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build per-axis range mapping module for orientation axes (pitch, roll, yaw)</name>
  <files>max/sensor-pipeline.maxpat</files>
  <action>
Add a range mapping section below the smoothing module. Start with the 3 orientation axes (pitch, roll, yaw) as these are the most commonly mapped. Each axis gets an identical mapping module.

PER-AXIS MAPPING MODULE (build once, replicate 3 times for pitch/roll/yaw):

INPUT RANGE CONTROLS:
- 2 flonum objects: "In Min" and "In Max" for manual entry of input range
- Learn mode button: textbutton in toggle mode, text "Learn" / "Stop" (same UX pattern as calibration per research recommendation)
- [maximum] object tracks running max during learn; [minimum] object tracks running min during learn
- When learn starts: send "clear" message to both maximum and minimum objects (prevents stale values from previous learn -- see Pitfall 8)
- While learning: smoothed axis value feeds into maximum and minimum objects; their output updates the In Min and In Max flonums
- When learn stops: final In Min/In Max values remain in the flonums for the scale object to use
- Manual flonum entry always works -- user can type values to override or fine-tune learned range

CURVE TYPE SELECTOR:
- Use MAX `umenu` (dropdown menu) or 3 radio-style textbuttons for: Linear (1), Exponential (2), Custom (3)
- Wire selector output to a [gate 3] object that routes the smoothed input to the appropriate mapping path:
  - Gate output 1 (Linear): [scale in_min in_max out_min out_max] -- exponent = 1.0 (default)
  - Gate output 2 (Exponential): [scale in_min in_max out_min out_max 3.] -- exponent parameter for exponential curve (use a flonum/dial to let user adjust the exponent, default 3.0)
  - Gate output 3 (Custom): [function @mode 1] -- user-drawn breakpoint curve
- All three paths merge back to a single output via another gate or using the [selector] approach

IMPORTANT for scale object: Use float arguments with decimal points (e.g., `scale 0. 90. 200. 2000.`) to avoid integer truncation (Pitfall 2).

IMPORTANT for function object: Set domain and range to match input/output ranges using `setdomain` and `setrange` messages connected to the input/output range flonums. This prevents the X-range mismatch pitfall (Pitfall 3). The function object should be visible so the user can draw curves.

OUTPUT RANGE CONTROLS:
- 2 flonum objects: "Out Min" and "Out Max" for target parameter range
- These feed into the scale object's arguments and into the function object's setrange

CLIP TOGGLE:
- textbutton or toggle: "Clip On/Off"
- When ON: output passes through [clip out_min out_max] to constrain values
- When OFF: output bypasses clip (use [gate] to route around clip object)

MAPPED OUTPUT:
- flonum displaying the final mapped value for each axis
- Use [send] to broadcast: [s mapped_pitch], [s mapped_roll], [s mapped_yaw]

INPUT DATA:
- Receive smoothed orientation values via [r smooth_pitch], [r smooth_roll], [r smooth_yaw] from Plan 01

LAYOUT:
- Comment banner "=== RANGE MAPPING ==="
- Subsection comments for each axis: "--- Pitch Mapping ---", "--- Roll Mapping ---", "--- Yaw Mapping ---"
- Each axis module arranged horizontally: learn button | in min/max | curve selector | function editor | out min/max | clip toggle | mapped output
- Stack the 3 axis modules vertically

DEFAULT VALUES:
- In Min: 0., In Max: 90. (reasonable for orientation degrees)
- Out Min: 0., Out Max: 1. (normalized output)
- Curve type: Linear (1)
- Clip: OFF
- Exponent: 3.0 (for exponential mode)
  </action>
  <verify>
Open sensor-pipeline.maxpat in MAX. Verify:
1. Three mapping modules visible (pitch, roll, yaw) with all controls
2. Linear mode: tilting board produces smoothly mapped output within the output range
3. Exponential mode: tilting board produces curved response (slow at low angles, fast at high)
4. Custom mode: function object is visible and drawable; drawn curve affects mapping
5. Learn mode: pressing Learn, waving board, pressing Stop populates In Min/In Max correctly
6. Learn mode clears previous values on second use (no stale min/max)
7. Clip ON constrains output to Out Min/Out Max; Clip OFF allows overflow
8. Manual flonum entry for In Min/In Max overrides learned values
  </verify>
  <done>3 orientation axis mapping modules operational with linear/exponential/custom curves, learn mode, clip toggle, and mapped output display</done>
</task>

<task type="auto">
  <name>Task 2: Replicate mapping module for accelerometer axes (aX, aY, aZ) and gyro axes (gX, gY, gZ)</name>
  <files>max/sensor-pipeline.maxpat</files>
  <action>
Replicate the mapping module pattern from Task 1 for the remaining 6 axes: accelerometer (aX, aY, aZ) and gyroscope (gX, gY, gZ).

ACCELEROMETER MAPPING (3 modules):
- Input from [r smooth_ax], [r smooth_ay], [r smooth_az]
- Default In Min: -2., In Max: 2. (accelerometer range in g)
- Default Out Min: 0., Out Max: 1.
- Broadcast mapped output: [s mapped_ax], [s mapped_ay], [s mapped_az]

GYROSCOPE MAPPING (3 modules):
- Input from [r smooth_gx], [r smooth_gy], [r smooth_gz]
- Default In Min: -250., In Max: 250. (gyroscope range in degrees/sec)
- Default Out Min: 0., Out Max: 1.
- Broadcast mapped output: [s mapped_gx], [s mapped_gy], [s mapped_gz]

Each module is identical in structure to the orientation modules from Task 1. Copy the same pattern: learn button, in min/max flonums, curve selector (linear/exp/custom with gate), function object, out min/max flonums, clip toggle, mapped output flonum.

LAYOUT:
- Add subsections: "--- Accel X Mapping ---", "--- Accel Y Mapping ---", etc.
- Stack below the orientation mapping modules
- Consider grouping: Orientation mappings, then Accel mappings, then Gyro mappings with group comment banners

NOTE: Given the large number of controls (9 axes x ~8 controls each), consider using subpatchers ([p map_pitch], [p map_roll], etc.) to keep the main patch manageable. If using subpatchers, expose the key controls via inlets/outlets or [send]/[receive] pairs. The decision on subpatchers vs inline is Claude's discretion per CONTEXT.md, but readability should be prioritized.
  </action>
  <verify>
Open sensor-pipeline.maxpat in MAX. Verify:
1. All 9 axis mapping modules are present and functional
2. Accelerometer mapping responds to board tilt (aX, aY values change)
3. Gyroscope mapping responds to board rotation speed (gX, gY, gZ values change)
4. Learn mode works on all 9 axes
5. All 3 curve types work on all 9 axes
6. Clip toggle works on all 9 axes
7. Mapped output values display correctly for all 9 axes
  </verify>
  <done>All 9 sensor axes have per-axis range mapping modules with linear/exponential/custom curves, learn mode, clip toggle, and mapped output -- completing MAXI-02</done>
</task>

</tasks>

<verification>
- 9 mapping modules exist (one per sensor axis)
- Each module has: input range controls, learn mode, curve type selector, function object, output range controls, clip toggle, mapped output display
- Linear, exponential, and custom curve modes produce correct output on all axes
- Learn mode captures actual movement range without retaining stale values
- Clip toggle constrains or allows overflow per axis
- Scale objects use float arguments (no integer truncation)
- Function objects have correct domain/range matching input/output ranges
- Mapped values broadcast via send objects for downstream use
</verification>

<success_criteria>
- MAXI-02 (range mapping): All 9 axes independently mappable with 3 curve types, learn mode, and clip toggle
- User can map pitch 0-90 to frequency 200-2000 Hz with exponential curve as a representative test case
- User can draw a custom transfer curve and see it applied in real time
</success_criteria>

<output>
After completion, create `.planning/phases/04-musical-tools/04-02-SUMMARY.md`
</output>
