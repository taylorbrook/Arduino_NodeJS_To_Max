---
phase: 06-threshold-triggers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - max/imu-sensor.maxpat
autonomous: true

must_haves:
  truths:
    - "Sending 'threshold pitch 45' to the control inlet causes outlet 12 to fire 'pitch up' when pitch crosses above 45 and 'pitch down' when it crosses below"
    - "Hysteresis prevents oscillation: when sensor hovers near the threshold boundary, no rapid repeated firing occurs"
    - "All 6 axes (pitch, roll, yaw, ax, ay, az) support independent thresholds with configurable hysteresis"
    - "Dead 'prepend threshold -> node.script' wiring is removed; threshold messages are handled entirely in MAX"
  artifacts:
    - path: "max/imu-sensor.maxpat"
      provides: "6 threshold subpatchers with hysteresis, threshold config router, triggers outlet wiring"
      contains: "p thresh_pitch"
  key_links:
    - from: "control inlet route threshold"
      to: "threshold subpatchers"
      via: "route pitch roll yaw ax ay az dispatches threshold value + hysteresis to each subpatcher"
    - from: "smoothed data route"
      to: "threshold subpatchers"
      via: "t l l l third outlet feeds unpack -> per-axis threshold subpatchers"
    - from: "threshold subpatchers"
      to: "outlet 13 (triggers, displayed as outlet 12)"
      via: "prepend axis_name tags output, all 6 axes merge into triggers outlet"
---

<objective>
Build 6 threshold subpatchers with hysteresis in imu-sensor.maxpat abstraction, wire them to smoothed sensor data and the triggers outlet (outlet 12 in MAX display, index 13 in JSON), and connect the control inlet threshold route to configure thresholds via messages.

Purpose: Implements MAXI-03 (threshold/event detection), the single remaining v1.0 requirement. Users can define thresholds that fire discrete trigger events when orientation or acceleration crosses a boundary.
Output: imu-sensor.maxpat with fully functional threshold triggers on all 6 axes.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-threshold-triggers/06-RESEARCH.md
@.planning/phases/05-abstraction-wifi/05-02-SUMMARY.md
@max/imu-sensor.maxpat
@max/sensor-pipeline.maxpat (reference: threshold subpatchers at lines 10600-15300)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build threshold subpatchers and wire data flow in imu-sensor.maxpat</name>
  <files>max/imu-sensor.maxpat</files>
  <action>
Modify imu-sensor.maxpat to add complete threshold trigger functionality. This is a MAX patch JSON edit with three main wiring changes:

**A. Remove dead threshold-to-Node wiring:**
Find the patchline from the `route` object's threshold outlet to `prepend threshold` and from `prepend threshold` to `node.script`. Disconnect or remove these patchlines. The `threshold` keyword stays in the route object (it still dispatches threshold messages), but the output now goes to a new MAX-side threshold configuration chain instead of Node.

**B. Add threshold configuration chain:**
After the `route ... threshold ...` outlet, add:
- `route pitch roll yaw ax ay az` -- dispatches per-axis threshold configuration
- Each outlet connects to the corresponding threshold subpatcher's configuration inlet
- Message format: `threshold pitch 45` sets pitch threshold to 45 with default hysteresis. `threshold pitch 45 5` sets pitch threshold to 45 with hysteresis 5.
- Inside each threshold subpatcher, parse the incoming message: first value = threshold, optional second value = hysteresis (default 5 for orientation axes pitch/roll/yaw, default 0.2 for accel axes ax/ay/az).

**C. Create 6 threshold subpatchers (p thresh_pitch, p thresh_roll, p thresh_yaw, p thresh_ax, p thresh_ay, p thresh_az):**

Adapt the proven pattern from sensor-pipeline.maxpat threshold subpatchers. Each subpatcher contains:
- 2 inlets: inlet 1 = smoothed sensor value (float), inlet 2 = threshold configuration (list: threshold_value [hysteresis])
- 1 outlet: outputs "up" or "down" symbol when threshold is crossed
- Hysteresis logic:
  - `/ 2.` splits hysteresis into half-width
  - `+ 0.` computes upper_bound = threshold + half_width
  - `- 0.` computes lower_bound = threshold - half_width
  - `> upper_bound` -> `change` -> `select 1` -> message "up" (upward crossing)
  - `< lower_bound` -> `change` -> `select 1` -> message "down" (downward crossing)
- Default threshold values: 45 for orientation axes, 1.0 for accel axes
- Default hysteresis: 5 for orientation axes, 0.2 for accel axes
- Use `== 0` for logical NOT (not `!`)

**D. Wire smoothed data into threshold subpatchers:**
Currently, smoothed data flows through `t l l` objects (2 outlets: one to data outlet, one to mapping subpatcher). Add a third outlet to make `t l l l`:
- Outlet 1 (leftmost in trigger): to data outlet (unchanged)
- Outlet 2: to mapping subpatcher (unchanged)
- Outlet 3 (new, rightmost): to threshold data routing

For each sensor group (smooth_accel, smooth_gyro, smooth_orientation):
- The third `t l l l` outlet feeds an `unpack f f f`
- Each unpack outlet feeds the corresponding threshold subpatcher's data inlet (inlet 1)

Wiring map:
- smooth_accel -> unpack -> thresh_ax, thresh_ay, thresh_az
- smooth_gyro -> (no thresholds on gyro -- skip, gyro thresholds are less musically useful. Only build pitch/roll/yaw/ax/ay/az per the research.)
- smooth_orientation -> unpack -> thresh_pitch, thresh_roll, thresh_yaw

CORRECTION: The research specifies 6 axes: pitch, roll, yaw, ax, ay, az. Gyro axes (gx, gy, gz) are NOT included. So only smooth_accel and smooth_orientation need the third `t l l l` outlet. smooth_gyro stays as `t l l`.

**E. Wire threshold outputs to triggers outlet:**
Each threshold subpatcher's output gets tagged with its axis name:
- thresh_pitch outlet -> `prepend pitch` -> merge point
- thresh_roll outlet -> `prepend roll` -> merge point
- thresh_yaw outlet -> `prepend yaw` -> merge point
- thresh_ax outlet -> `prepend ax` -> merge point
- thresh_ay outlet -> `prepend ay` -> merge point
- thresh_az outlet -> `prepend az` -> merge point

All 6 prepend outputs connect to the triggers outlet (JSON index 13, MAX display index 12). This produces output like `pitch up`, `roll down`, `ax up`.

**Important MAX patch JSON conventions:**
- Every object needs a unique `id` (use pattern like `obj-thresh-pitch-1`, `obj-thresh-route`, etc.)
- Subpatchers use `patcher` key inside the object `box`
- Patchlines connect source `[id, outlet_index]` to destination `[id, inlet_index]`
- Use `numinlets`, `numoutlets`, `outlettype` arrays correctly
- Position objects with `patching_rect` [x, y, width, height]
  </action>
  <verify>
Open imu-sensor.maxpat in a text editor and verify:
1. No patchline connects threshold route output to `prepend threshold` -> `node.script`
2. A `route pitch roll yaw ax ay az` object exists and receives threshold messages from the control inlet route
3. Six `p thresh_*` subpatchers exist with correct hysteresis logic (>, <, change, select 1)
4. `t l l l` objects exist on smooth_accel and smooth_orientation routes (3 outlets, not 2)
5. All 6 threshold subpatcher outputs connect through `prepend <axis>` to the triggers outlet (index 13)
6. JSON is valid (no syntax errors)
  </verify>
  <done>
imu-sensor.maxpat contains 6 working threshold subpatchers with hysteresis, wired to smoothed data input and triggers outlet output, configurable via 'threshold axis value [hysteresis]' messages on the control inlet. Dead Node wiring removed.
  </done>
</task>

</tasks>

<verification>
1. Open max/imu-sensor.maxpat in MAX
2. Send test signal via help patch or live Arduino
3. Send `threshold pitch 45` to control inlet
4. Verify outlet 12 (triggers) outputs `pitch up` when pitch exceeds 45 and `pitch down` when it drops below
5. Verify hysteresis: send `threshold pitch 45 10` and confirm no oscillation when pitch hovers near 45
6. Repeat for at least one accel axis: `threshold ax 1.0` and verify `ax up`/`ax down` on outlet 12
</verification>

<success_criteria>
- 6 threshold subpatchers exist in imu-sensor.maxpat with hysteresis logic
- Control inlet `threshold <axis> <value> [hysteresis]` configures thresholds
- Triggers outlet (12) outputs `<axis> up` and `<axis> down` messages
- No dead wiring to Node.js for threshold processing
- JSON is valid and patch loads without errors in MAX
</success_criteria>

<output>
After completion, create `.planning/phases/06-threshold-triggers/06-01-SUMMARY.md`
</output>
