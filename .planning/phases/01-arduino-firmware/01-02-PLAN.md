---
phase: 01-arduino-firmware
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Serial Monitor shows continuous CSV lines at steady rate with 9 values and no gaps or NaN"
    - "Tilting the board produces smooth responsive pitch and roll matching physical orientation"
    - "Rotating the board produces yaw tracking relative heading"
    - "Measured loop rate printed at startup matches the Madgwick filter declared sample rate"
    - "Serial output sustains for 10+ minutes without corruption freezing or overflow"
  artifacts:
    - path: "firmware/imu_firmware/imu_firmware.ino"
      provides: "Hardware-validated firmware (may have tuning adjustments from verification)"
      contains: "LSM6DS3"
  key_links:
    - from: "Arduino board USB"
      to: "Serial Monitor output"
      via: "USB serial at 57600 baud"
      pattern: "9 comma-separated values per line"
---

<objective>
Upload the firmware to the Arduino Uno WiFi Rev2, verify it produces correct sensor output on real hardware, and tune any parameters that need adjustment based on actual measured behavior.

Purpose: The firmware was written and compiled in Plan 01 but cannot be validated without physical hardware. This plan connects the code to reality -- confirming loop rate, verifying sensor readings, testing stability, and optionally probing the 57600 vs 115200 baud question.
Output: A hardware-validated firmware with confirmed loop rate and stable output.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-arduino-firmware/01-CONTEXT.md
@.planning/phases/01-arduino-firmware/01-RESEARCH.md
@.planning/phases/01-arduino-firmware/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upload firmware to Arduino board</name>
  <files></files>
  <action>
    1. Detect the connected Arduino board: `arduino-cli board list` -- find the port (likely /dev/cu.usbmodemXXXX on macOS).
    2. Upload the compiled sketch: `arduino-cli upload --fqbn arduino:megaavr:uno2018 --port [DETECTED_PORT] firmware/imu_firmware/`
    3. If upload fails, troubleshoot: confirm board is plugged in, correct FQBN, correct port. If port not detected, user may need to check USB cable.
    4. After successful upload, wait 3 seconds for the board to reset and start.
    5. Read initial serial output to confirm STARTUP line appears: `arduino-cli monitor --port [DETECTED_PORT] --config baudrate=57600` (capture first ~20 lines).

    If the board is not detected or upload fails with a permissions error, create a checkpoint for the user to physically connect the board.
  </action>
  <verify>
    Upload command exits with code 0.
    Serial monitor shows the STARTUP line containing `device=ARUIDO_IMU` and a `rate_hz` value.
    Subsequent lines are CSV with 9 comma-separated numeric values.
  </verify>
  <done>Firmware uploaded successfully. STARTUP line visible in serial output. CSV data lines flowing.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify sensor output on physical hardware</name>
  <files></files>
  <action>
    CHECKPOINT: User must physically verify sensor output on the Arduino board.

    What was built: Complete IMU firmware that reads LSM6DS3 via SPI, runs Madgwick filter with measured sample rate, applies EMA smoothing to orientation, outputs 9-value CSV at 57600 baud, prints startup header, and accepts 'R' reset command.

    User should open Arduino Serial Monitor at 57600 baud (or use `arduino-cli monitor --port [PORT] --config baudrate=57600`) and perform the following verification steps:

    Step 1 -- Startup line:
    Confirm the first line starts with STARTUP,device=ARUIDO_IMU,version=1.0,rate_hz=XX.X
    Note the rate_hz value. Expected: 70-90 Hz. If dramatically different, report the value.

    Step 2 -- CSV format:
    Confirm data lines contain exactly 9 comma-separated numbers with 2 decimal places each.
    Example: -0.02,0.01,1.00,0.45,-0.12,0.03,1.23,-0.45,178.90
    No NaN, no Inf, no text mixed into data lines.

    Step 3 -- Pitch and roll response:
    Hold board flat: pitch and roll should both be near 0 (within +/-5 degrees).
    Tilt board forward 90 degrees: pitch should approach +/-90.
    Tilt board sideways 90 degrees: roll should approach +/-90.
    Values should respond smoothly without large jumps or oscillation.

    Step 4 -- Yaw response:
    Rotate board slowly on a flat surface: yaw should change steadily.
    Note: yaw WILL drift slowly when stationary -- this is expected with 6DOF (no magnetometer).
    Confirm yaw is moving, not stuck at 0.

    Step 5 -- Stability test:
    Let the output run for at least 2 minutes. Confirm no freezing or gaps in output, no garbled/corrupted lines, values remain sensible (not exploding to infinity).

    Step 6 -- Reset command (optional):
    Send the character R via Serial Monitor. Confirm output pauses briefly (warmup re-runs), a new STARTUP line appears with rate_hz, and data resumes normally.

    Step 7 -- Baud rate test (optional, low priority):
    If curious, try changing BAUD_RATE to 115200, recompile, upload, and check if output is clean or garbled. Report result either way -- this validates the forum-sourced 57600 ceiling.

    Resume signal: Type "approved" if all checks pass, or describe what needs fixing (e.g., "pitch seems inverted", "loop rate is only 40 Hz", "garbled output at 57600").
  </action>
  <verify>User reports "approved" or provides specific feedback on what needs adjustment.</verify>
  <done>User has physically verified the firmware output on real hardware and provided feedback.</done>
</task>

<task type="auto">
  <name>Task 3: Apply tuning adjustments based on hardware verification</name>
  <files>firmware/imu_firmware/imu_firmware.ino</files>
  <action>
    Based on user feedback from the hardware verification checkpoint:

    **If approved with no issues:** No changes needed. Skip this task.

    **If loop rate is significantly different from expected (~80 Hz):**
    - The firmware already auto-measures its rate, so the Madgwick filter self-corrects.
    - If rate is below 60 Hz, investigate: check if sensor ODR should be lowered, or if serial output line is too long.
    - If rate is above 90 Hz, the firmware handles this fine (bandwidth math was conservative).

    **If pitch/roll are inverted or swapped:**
    - Swap or negate the appropriate axis readings from readFloatAccelX/Y/Z and readFloatGyroX/Y/Z.
    - The axis mapping depends on physical board orientation relative to the Madgwick library's convention.

    **If smoothing is too aggressive (laggy) or too light (jittery):**
    - Adjust SMOOTH_ALPHA: decrease toward 0.1 for more smoothing, increase toward 0.3 for less.
    - Recompile and re-upload after adjustment.

    **If serial output is garbled:**
    - Confirm baud rate matches between firmware and serial monitor (57600).
    - If garbled at 57600, this is a hardware issue -- check USB cable, try different port.

    **If 115200 baud works clean:**
    - Update BAUD_RATE constant to 115200. This is a major win -- nearly doubles throughput ceiling.
    - Recompile and re-upload.

    After any changes, recompile: `arduino-cli compile --fqbn arduino:megaavr:uno2018 firmware/imu_firmware/`
    Re-upload: `arduino-cli upload --fqbn arduino:megaavr:uno2018 --port [PORT] firmware/imu_firmware/`
  </action>
  <verify>
    If changes were made: sketch recompiles cleanly and re-uploads successfully.
    If no changes needed: this task is a no-op (approved on first try).
  </verify>
  <done>
    Firmware is hardware-validated. Any necessary tuning applied. The sketch compiles, uploads, and produces correct sensor output on the physical Arduino Uno WiFi Rev2.
  </done>
</task>

</tasks>

<verification>
All 5 Phase 1 Success Criteria from ROADMAP.md are verified on physical hardware:
1. Continuous CSV lines at steady rate with 9 values, no gaps/NaN
2. Smooth responsive pitch/roll matching physical orientation
3. Yaw tracking relative heading (drift acceptable)
4. Measured loop rate matches Madgwick declared sample rate
5. Sustained output for 10+ minutes without corruption
</verification>

<success_criteria>
- Firmware runs on physical Arduino Uno WiFi Rev2
- STARTUP header line contains measured loop rate
- 9-value CSV output is clean and continuous
- Orientation values respond correctly to physical movement
- Output is stable over extended duration
- Any necessary tuning adjustments have been applied
</success_criteria>

<output>
After completion, create `.planning/phases/01-arduino-firmware/01-02-SUMMARY.md`
</output>
