---
phase: 05-abstraction-wifi
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - max/imu-sensor.maxpat
  - max/imu-sensor-3dviz.maxpat
autonomous: true

must_haves:
  truths:
    - "User can create an [imu-sensor] object in any MAX patch and get working sensor data when the abstraction directory is in MAX's search path"
    - "Abstraction accepts port name as first argument and optional @smooth, @transport, @ip, @udpport attributes"
    - "All outlet types are exposed: status, raw accel/gyro/orientation, calibrated, smoothed, mapped, quaternion, triggers"
    - "User can control the abstraction via messages to the left inlet without opening it (smoothing, threshold, transport, calibrate, mapping)"
    - "3D visualization is a separate companion patch that connects to the abstraction's quaternion outlet"
    - "Transport dropdown inside the abstraction allows interactive usb/wifi/auto switching"
  artifacts:
    - path: "max/imu-sensor.maxpat"
      provides: "Drop-in MAX abstraction encapsulating entire sensor pipeline"
      contains: "patcherargs"
    - path: "max/imu-sensor-3dviz.maxpat"
      provides: "Companion 3D visualization patch connecting to quaternion outlet"
      contains: "jit.gl"
  key_links:
    - from: "max/imu-sensor.maxpat"
      to: "node/serial-bridge.js"
      via: "node.script loading serial-bridge.js"
      pattern: "node\\.script.*serial-bridge"
    - from: "max/imu-sensor.maxpat"
      to: "parent patch"
      via: "inlet and outlet objects with @comment attributes"
      pattern: "outlet.*@comment"
    - from: "max/imu-sensor-3dviz.maxpat"
      to: "max/imu-sensor.maxpat"
      via: "inlet receiving quaternion data from abstraction's quaternion outlet"
      pattern: "jit\\.euler2quat|rotatexyz"
---

<objective>
Package the entire sensor pipeline as a drop-in MAX abstraction (imu-sensor.maxpat) with clean inlets/outlets, patcherargs for configuration, and message-based control. Extract the 3D visualization as a separate companion patch (imu-sensor-3dviz.maxpat).

Purpose: Users can drop a single [imu-sensor] object into any MAX patch and get working sensor data with all smoothing, mapping, calibration, and quaternion functionality accessible via messages and attributes.

Output: imu-sensor.maxpat abstraction, imu-sensor-3dviz.maxpat companion patch.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-abstraction-wifi/05-RESEARCH.md
@.planning/phases/05-abstraction-wifi/05-CONTEXT.md
@.planning/phases/05-abstraction-wifi/05-01-SUMMARY.md
@.planning/phases/04-musical-tools/04-01-SUMMARY.md
@.planning/phases/04-musical-tools/04-02-SUMMARY.md
@max/sensor-pipeline.maxpat
@node/serial-bridge.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create imu-sensor.maxpat abstraction with full inlet/outlet API and message routing</name>
  <files>max/imu-sensor.maxpat</files>
  <action>
  Create a new MAX patch `max/imu-sensor.maxpat` that encapsulates the entire sensor pipeline as a reusable abstraction. This is a NEW file (not a modification of sensor-pipeline.maxpat -- that file remains as a standalone reference).

  **Outlet order (left to right, 0-indexed):**
  0. status -- transport-aware status strings (connected-usb, connected-wifi, switching, disconnected, etc.)
  1. raw_accel -- raw accelerometer (3 floats: ax, ay, az)
  2. raw_gyro -- raw gyroscope (3 floats: gx, gy, gz)
  3. raw_orientation -- raw orientation (3 floats: pitch, roll, yaw)
  4. cal_accel -- calibrated accelerometer (3 floats)
  5. cal_gyro -- calibrated gyroscope (3 floats)
  6. cal_orientation -- calibrated orientation (3 floats)
  7. smooth_accel -- smoothed accelerometer (3 floats)
  8. smooth_gyro -- smoothed gyroscope (3 floats)
  9. smooth_orientation -- smoothed orientation (3 floats)
  10. mapped -- mapped values (tagged: axis_name followed by float, e.g., "pitch 0.5")
  11. quaternion -- quaternion (4 floats: qX, qY, qZ, qW)
  12. triggers -- threshold triggers (tagged: axis_name followed by bang/direction)

  Each outlet MUST have `@comment` attribute documenting its purpose. Place outlets in a precise left-to-right row -- outlet position determines index.

  **Inlet:**
  Single inlet (index 0) with `@comment "control messages"`. All configuration arrives as messages to this inlet.

  **Internal structure:**

  1. **patcherargs** -- parse arguments:
     ```
     [patcherargs /dev/tty.usbmodem1234 @smooth 0.3 @transport usb @ip 192.168.1.50 @udpport 8889]
     ```
     - Left outlet: positional arg #1 (port name)
     - Right outlet: @attribute values (one at a time as "attrname value" lists)

     Wire left outlet -> `prepend connect` -> `deferlow` -> node.script (auto-connect to specified port).
     Wire right outlet -> `route smooth transport ip udpport` -> dispatch to respective handlers on node.script.

  2. **node.script** -- loads serial-bridge.js:
     ```
     [node.script serial-bridge.js @autostart 1]
     ```
     Use `@file` or keep serial-bridge.js in the same directory. The script path resolves via MAX search path when the .js file is alongside the .maxpat.

  3. **Route dispatcher for control inlet:**
     Wire the control inlet through a `route` object:
     ```
     [inlet]
       |
     [route smoothing threshold transport calibrate orient_reset orient_restore mapping connect disconnect]
     ```
     Each route outlet dispatches to the appropriate handler:
     - `smoothing` -> further route by target (global, accel_group, gyro_group, orient_group, ax, ay, az, etc.) -> send to Node smooth handlers
     - `threshold` -> send to Node threshold handler (axis + value)
     - `transport` -> send to Node transport handler (usb/wifi/auto)
     - `calibrate` -> send calibrate_start to Node (toggle behavior)
     - `orient_reset` -> send orient_reset to Node
     - `orient_restore` -> send orient_restore to Node
     - `mapping` -> route by axis -> send mapping parameters to Node
     - `connect` -> send connect to Node (with optional port arg)
     - `disconnect` -> send disconnect to Node

  4. **Transport dropdown UI (inside abstraction):**
     ```
     [umenu @items usb wifi auto]
       |
     [select 0 1 2]
       |     |    |
     [message transport usb] [message transport wifi] [message transport auto]
       |
     [node.script]
     ```
     This is the interactive transport selector. It lives inside the abstraction but is NOT visible from outside -- users interact via messages to the inlet or by opening the abstraction. The @transport attribute from patcherargs initializes this umenu.

  5. **Smoothing module** -- Replicate the three-tier smoothing from sensor-pipeline.maxpat:
     - 13 dials (1 global, 3 group, 9 per-axis) with multiplication chains
     - 9 slide objects receiving calibrated data from node.script route
     - Smoothed outputs go to smooth_accel/gyro/orientation outlets AND to mapping subpatchers
     - The @smooth attribute sets the global dial's initial value

  6. **Quaternion module** -- jit.euler2quat from raw orientation and smoothed orientation:
     - Raw orientation -> jit.euler2quat -> quaternion outlet
     - Smoothed orientation -> jit.euler2quat -> send quat_smooth (for 3D viz companion)

  7. **Mapping subpatchers** -- 9 subpatchers (p map_pitch, p map_roll, etc.):
     - Replicate the per-axis mapping from sensor-pipeline.maxpat Plan 04-02
     - Mapped outputs -> tagged messages to mapped outlet (e.g., "pitch 0.5")

  8. **Threshold module** -- (if implemented in Phase 4 Plan 03, replicate here; if not yet implemented, add placeholder routing from threshold route to node.script handler with outlet wiring)

  9. **Routing from node.script to outlets:**
     Wire node.script left outlet through route:
     ```
     [node.script]
       |
     [route accel gyro orientation cal_accel cal_gyro cal_orientation status cal_status cal_progress cal_bias cal_toggle smooth_accel smooth_gyro smooth_orientation]
     ```
     - accel -> outlet 1 (raw_accel)
     - gyro -> outlet 2 (raw_gyro)
     - orientation -> outlet 3 (raw_orientation)
     - cal_accel -> (feed to smoothing) AND outlet 4
     - cal_gyro -> (feed to smoothing) AND outlet 5
     - cal_orientation -> (feed to smoothing) AND outlet 6
     - status -> outlet 0
     - smooth_* values from slide objects -> outlets 7-9

  10. **Initialization with deferlow:**
      ```
      [loadbang]
        |
      [deferlow]
        |
      [message connect #1]  -- auto-connect to port argument
        |
      [node.script]
      ```
      Use deferlow to prevent "not ready" warnings (established pattern from MEMORY.md).

  IMPORTANT: This is a large .maxpat JSON file. The structure follows the same JSON format as the existing sensor-pipeline.maxpat. Use the established MAX patch JSON patterns from prior phases.

  IMPORTANT: Use `#0` prefix for all internal send/receive pairs to create instance-unique names (e.g., `s #0_smooth_pitch`). This prevents conflicts when multiple abstraction instances exist. Do NOT use `#0` on outlet objects -- those are the public API.

  IMPORTANT: The abstraction does NOT include the 3D visualization (per user decision). That goes in the companion patch (Task 2).

  IMPORTANT: sensor-pipeline.maxpat remains unchanged as a standalone reference/development patch. The abstraction is a NEW file that reorganizes the same logic.
  </action>
  <verify>
  Check that max/imu-sensor.maxpat:
  - Is valid JSON
  - Contains 1 inlet object with @comment
  - Contains 13 outlet objects with @comment attributes
  - Contains a patcherargs object
  - Contains a node.script object referencing serial-bridge.js
  - Contains a route object for inlet message dispatch
  - Contains a umenu for transport selection
  - Contains deferlow for initialization
  - Contains jit.euler2quat for quaternion computation
  - Contains slide objects for smoothing
  </verify>
  <done>imu-sensor.maxpat is a complete abstraction that can be instantiated as [imu-sensor portname @smooth 0.3 @transport usb] in any MAX patch. All 13 outlets deliver tagged sensor data. Control inlet accepts smoothing/threshold/transport/calibrate/mapping messages. Transport dropdown provides interactive switching.</done>
</task>

<task type="auto">
  <name>Task 2: Create imu-sensor-3dviz.maxpat companion visualization patch</name>
  <files>max/imu-sensor-3dviz.maxpat</files>
  <action>
  Create `max/imu-sensor-3dviz.maxpat` as a standalone companion patch for 3D orientation visualization. This connects to the abstraction's quaternion outlet (outlet 11) or receives quaternion data via the `quat_smooth` send from the abstraction's internal smoothed quaternion path.

  **Design:**

  1. **Inlet** for quaternion data (4 floats: qX, qY, qZ, qW) -- user wires this to the imu-sensor abstraction's quaternion outlet.

  2. **Alternative receive path:** `[r quat_smooth]` for receiving smoothed quaternion data broadcast from inside the abstraction. This is a convenience -- users can either wire the outlet or use the broadcast.
     NOTE: If the abstraction uses `#0` prefix on sends, the broadcast path won't work across instances. In that case, use ONLY the inlet path and document this.

  3. **Jitter 3D visualization:**
     - `[jit.world]` or `[jit.gl.render]` context for OpenGL rendering
     - `[jit.gl.gridshape @shape cube]` or similar geometric shape representing the sensor board
     - Apply quaternion rotation via `rotatexyz` (order: X=pitch, Y=yaw, Z=roll per MEMORY.md)
     - Alternatively, use Euler angles from the quaternion for rotation: unpack the inlet quaternion or use a second inlet for Euler angles

  4. **Simple approach (Euler-based, matches existing 3D viz pattern from Phase 4):**
     ```
     [inlet @comment "orientation: pitch roll yaw"]
       |
     [unpack f f f]
       |     |    |
     pitch  roll  yaw
       |     |    |
     [pak rotatexyz 0. 0. 0.]  -- X=pitch, Y=yaw, Z=roll
       |
     [jit.gl.sketch @drawto ctx]
     ```

     Actually, provide TWO inlets:
     - Inlet 0: Euler angles (pitch, roll, yaw -- 3 floats, connect to abstraction's smooth_orientation outlet 9)
     - Inlet 1: Quaternion (4 floats -- connect to abstraction's quaternion outlet 11, for future quaternion-native rotation)

     For the initial implementation, use Euler angles for the rotation (simpler, matches existing code).

  5. **Rendering setup:**
     - `[jit.gl.render ctx @erase_color 0.2 0.2 0.2 1]` -- dark gray background
     - `[jit.gl.gridshape ctx @shape cube @scale 2.0 0.3 1.5 @color 0.3 0.6 1.0 1.0]` -- flat rectangular board shape
     - `[jit.world ctx @visible 1 @size 400 300]` -- visualization window
     - Apply orientation via `rotatexyz` message to the gridshape

  6. **Metro for render loop:**
     ```
     [toggle] -- "Enable 3D View"
       |
     [metro 16]  -- ~60fps render rate
       |
     [bang]
       |
     [jit.gl.render ctx]
     ```

  7. **Labels** -- comment boxes explaining:
     - "Connect inlet 0 to imu-sensor smooth_orientation outlet"
     - "Connect inlet 1 to imu-sensor quaternion outlet (optional)"
     - "Toggle to start/stop 3D rendering"

  Keep this patch lightweight. It is a visualization tool, not part of the data pipeline.
  </action>
  <verify>
  Check that max/imu-sensor-3dviz.maxpat:
  - Is valid JSON
  - Contains at least 1 inlet for orientation data
  - Contains jit.gl.render or jit.world context
  - Contains jit.gl.gridshape or similar 3D object
  - Contains metro for render loop
  - Contains rotatexyz for orientation application
  </verify>
  <done>imu-sensor-3dviz.maxpat is a standalone companion visualization patch. Users connect it to the abstraction's orientation or quaternion outlet to see real-time 3D board orientation. It is separate from the abstraction per user decision.</done>
</task>

</tasks>

<verification>
1. max/imu-sensor.maxpat is valid JSON and contains all required objects (patcherargs, node.script, route, inlet, 13 outlets, umenu, deferlow, slide, jit.euler2quat)
2. max/imu-sensor-3dviz.maxpat is valid JSON with Jitter 3D rendering objects
3. Outlet order matches the documented API (status=0, raw_accel=1, ... triggers=12)
4. Control inlet routes messages to appropriate internal handlers
5. patcherargs processes #1 port argument and @smooth/@transport/@ip/@udpport attributes
6. sensor-pipeline.maxpat is unchanged (still exists as standalone reference)
</verification>

<success_criteria>
- [imu-sensor] can be instantiated in a MAX patch with port argument and @attributes
- All 13 outlets deliver correctly routed sensor data
- Message-based control works for smoothing, transport, calibration, and mapping
- 3D visualization is a separate lightweight companion patch
- No modifications to sensor-pipeline.maxpat or serial-bridge.js
</success_criteria>

<output>
After completion, create `.planning/phases/05-abstraction-wifi/05-02-SUMMARY.md`
</output>
