---
phase: 08-custom-dtw-gesture-recognition
plan: 03
type: execute
wave: 2
depends_on:
  - "08-01"
  - "08-02"
files_modified:
  - max/imu-gesture.maxpat
autonomous: false
requirements:
  - DTW-01
  - DTW-02
  - DTW-04
  - DTW-06
  - DTW-07
  - DTW-08

must_haves:
  truths:
    - "User can click Record to start recording a custom gesture and see recording progress feedback"
    - "User can see per-gesture slot rows with enable/disable, threshold, cooldown, and delete controls"
    - "User can switch between timed and toggle recording modes"
    - "User can save gesture library to JSON file via file dialog and load it back"
    - "User can see DTW match triggered events and continuous confidence values routed to outlets"
    - "DTW match outputs appear on dedicated outlets alongside existing predefined gesture outlets"
  artifacts:
    - path: "max/imu-gesture.maxpat"
      provides: "DTW recording controls, per-gesture slot UI rows, save/load dialogs, match output routing"
      min_lines: 500
  key_links:
    - from: "max/imu-gesture.maxpat (record button)"
      to: "gesture-engine.js (dtw_record_start handler)"
      via: "prepend dtw_record_start -> node.script"
      pattern: "dtw_record_start"
    - from: "max/imu-gesture.maxpat (save/load)"
      to: "gesture-engine.js (dtw_save/dtw_load handlers)"
      via: "savedialog/opendialog -> prepend -> node.script"
      pattern: "dtw_(save|load)"
    - from: "gesture-engine.js (DTW outlets)"
      to: "max/imu-gesture.maxpat (route object)"
      via: "node.script outlet -> route dtw_match dtw_confidence dtw_record_status dtw_status"
      pattern: "route.*dtw_match"
---

<objective>
Add DTW recording controls, per-gesture slot management UI, save/load file dialogs, and match output routing to imu-gesture.maxpat, connecting the MAX patch to all DTW handlers in gesture-engine.js.

Purpose: This is the user-facing interface for custom gesture recording, management, and recognition output. Without this patch, the DTW engine in gesture-engine.js has no way to receive commands or display results.
Output: Updated imu-gesture.maxpat with DTW controls section, 8 pre-wired gesture slot rows (expandable internally), and 2 new outlets for DTW match events and continuous confidence.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-custom-dtw-gesture-recognition/08-RESEARCH.md
@.planning/phases/08-custom-dtw-gesture-recognition/08-CONTEXT.md
@.planning/phases/08-custom-dtw-gesture-recognition/08-01-SUMMARY.md
@.planning/phases/08-custom-dtw-gesture-recognition/08-02-SUMMARY.md
@.planning/phases/07-core-engine-and-predefined-gestures/07-03-SUMMARY.md
@max/imu-gesture.maxpat
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DTW recording controls, slot management UI, save/load dialogs, and match output routing to imu-gesture.maxpat</name>
  <files>max/imu-gesture.maxpat</files>
  <action>
Extend imu-gesture.maxpat with a new DTW section below the existing predefined gesture rows. The patch is JSON -- edit the patcher's `boxes` and `lines` arrays.

**DTW Recording Controls Section:**
1. **Record button** (button object) labeled "Record" -- sends `dtw_record_start` to node.script via prepend
2. **Stop button** (button object) labeled "Stop" -- sends `dtw_record_stop`
3. **Recording mode toggle** (umenu with items "timed", "toggle") -- connects to slot ID packing
4. **Duration number box** (number~, default 2000) labeled "Duration ms" -- for timed mode recording window
5. **Slot ID number box** (number, default 1) labeled "Slot" -- which gesture slot to record into
6. **Recording status display** (message box) -- receives dtw_record_status from route
7. **Recording progress display** (number box) -- receives dtw_record_progress sample count from route
8. **Name text input** (textedit or message box) -- sends `dtw_name <slotId> <name>` to node.script

Wire the recording controls:
- Record button -> [pack i s i] (slotId, mode from umenu, duration) -> [prepend dtw_record_start] -> node.script inlet
- Stop button -> [message dtw_record_stop] -> node.script inlet
- Duration number -> connects to pack for dtw_record_start

**Per-Gesture Slot Rows (8 rows, following Phase 7 UI pattern):**
For each of 8 visible slot rows (the engine supports unlimited slots internally, but the patch shows 8):
1. **Enable toggle** (toggle) -> [prepend dtw_enable <slotId>] -> node.script
2. **Slot label** (comment showing "gesture-N" or custom name)
3. **Threshold dial** (dial, floatoutput 1, size 1.0, default 0.6) -> [prepend dtw_threshold <slotId>] -> node.script
4. **Cooldown dial** (dial, floatoutput 1, size 5000, default 500) labeled "cd ms" -> [prepend dtw_cooldown <slotId>] -> node.script
5. **Examples count display** (number box, readonly) showing how many examples recorded
6. **Delete button** (button) -> [message dtw_delete <slotId>] -> node.script

For pragmatic implementation: rather than creating 8 full independent rows of MAX objects (which would be ~200+ objects), create a minimum of 4-8 slot rows. If context is tight, 4 rows is acceptable -- the engine handles unlimited slots internally and additional slots are managed via text commands.

All dials and toggles should have `parameter_enable: 1` for state persistence (consistent with Phase 7 pattern).

**Match Mode and Continuous Stream Controls:**
1. **Match mode umenu** ("best", "all") -> [prepend dtw_match_mode] -> node.script
2. **Continuous stream toggle** -> [prepend dtw_continuous] -> node.script

**Save/Load Section:**
1. **Save button** (button) labeled "Save Library" -> [savedialog JSON] -> [prepend dtw_save] -> node.script
2. **Load button** (button) labeled "Load Library" -> [opendialog JSON] -> node.script via [prepend dtw_load]
3. **Clear All button** (button) labeled "Clear All" -> [message dtw_clear_all] -> node.script
4. **Library status display** (message box) -- receives dtw_status from route
5. **Library info display** (number box) -- receives dtw_library_info (count of loaded gestures)

**Outlet Routing:**
Add DTW-specific route branches from the node.script outlet. The existing route object handles gesture, engine_status, smooth_accel, etc. Extend it to also route:
- `dtw_match` -> new outlet (outlet index TBD, after existing 7 outlets)
- `dtw_confidence` -> new outlet (continuous confidence stream)
- `dtw_record_status` -> internal to recording status display
- `dtw_record_progress` -> internal to recording progress number
- `dtw_status` -> internal to library status display
- `dtw_library_info` -> internal to library info display
- `dtw_slot_info` -> internal to update slot example counts
- `dtw_axes_detected` -> internal to display detected axes
- `quaternion` -> new outlet (quaternion data from firmware)

**New outlets** to add to the abstraction (after existing 7):
- Outlet 7: DTW match events (gesture name + confidence)
- Outlet 8: DTW continuous confidence stream
- Outlet 9: Quaternion data (qw, qx, qy, qz)

Update the route object at the node.script left outlet to include all new DTW tags. The route should be:
```
route gesture engine_status smooth_accel smooth_gyro smooth_orientation status cal_status dtw_match dtw_confidence dtw_record_status dtw_record_progress dtw_status dtw_library_info dtw_slot_info dtw_axes_detected quaternion
```

Internal routes (dtw_record_status, dtw_record_progress, dtw_status, dtw_library_info, dtw_slot_info, dtw_axes_detected) go to display objects within the patch. External routes (dtw_match, dtw_confidence, quaternion) go to abstraction outlets.

**Layout:**
Position the DTW section below the existing predefined gesture rows with a clear visual separator (comment "--- Custom DTW Gestures ---"). Follow the existing visual style: left-aligned controls, consistent spacing.

IMPORTANT MAX PATCH EDITING NOTES:
- The patch is JSON. Each object is in the `patcher.boxes` array with an `id`, `maxclass`, `numinlets`, `numoutlets`, and `patching_rect` [x, y, width, height].
- Connections are in `patcher.lines` array as `patchline` objects with `source` [objectId, outletIndex] and `destination` [objectId, inletIndex].
- Use unique IDs for all new objects (e.g., `obj-200` onward to avoid conflicts with existing objects).
- Buttons use `maxclass: "button"`, toggles use `maxclass: "toggle"`, dials use `maxclass: "dial"`, number boxes use `maxclass: "number"`, comments use `maxclass: "comment"`, message boxes use `maxclass: "message"`.
- For `savedialog` and `opendialog`: `maxclass: "savedialog"` with `types: "JSON"` and `maxclass: "opendialog"` with `types: "JSON"`.
- The existing node.script object ID can be found by searching for `"maxclass": "newobj"` with `"text"` containing `"node.script"`.
  </action>
  <verify>
1. Open imu-gesture.maxpat in MAX and verify:
   - DTW recording controls are visible below predefined gesture rows
   - Record/Stop buttons are wired to node.script
   - Save/Load buttons trigger file dialogs
   - At least 4 gesture slot rows with enable/threshold/cooldown/delete
   - DTW match and continuous outlets are present
   - Quaternion outlet is present
2. Verify the JSON is valid: `python3 -c "import json; json.load(open('max/imu-gesture.maxpat'))"`
3. Count new outlets (should be 10 total: 7 existing + dtw_match + dtw_confidence + quaternion)
  </verify>
  <done>imu-gesture.maxpat has DTW recording controls (record/stop/mode/duration), per-gesture slot rows (enable/threshold/cooldown/delete), save/load file dialogs, match mode selector, continuous stream toggle, and 3 new outlets (DTW match, DTW confidence, quaternion).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify DTW recording and recognition with hardware</name>
  <files>max/imu-gesture.maxpat</files>
  <action>
Hardware verification checkpoint. Upload firmware and test the complete DTW pipeline end-to-end.

1. Upload firmware to Arduino: `arduino-cli upload -p /dev/cu.usbmodem* --fqbn arduino:megaavr:uno2018 firmware/imu_firmware/`
2. Open imu-gesture.maxpat in MAX
3. Verify Arduino connects and sensor data flows (check status display)
4. **Test Recording:**
   a. Set Slot to 1, mode to "timed", duration to 2000ms
   b. Click Record and perform a simple gesture (e.g., a horizontal swipe)
   c. Verify recording progress counter increments and stops after 2s
   d. Record 2 more examples of the same gesture (3 total)
   e. Verify "examples: 3" appears for slot 1
5. **Test Recognition:**
   a. Perform the recorded gesture -- verify dtw_match outlet fires with gesture name and confidence > 0.6
   b. Hold the device still -- verify no false triggers
   c. Perform an unrelated gesture -- verify no match fires (null rejection)
6. **Test Save/Load:**
   a. Click Save Library -- choose a location, save as .json
   b. Click Clear All -- verify all slots cleared
   c. Click Load Library -- load the saved file
   d. Verify gesture recognition resumes after load
7. **Test Toggle Recording:**
   a. Switch mode to "toggle"
   b. Click Record, perform gesture, click Stop
   c. Verify frames recorded match gesture duration
  </action>
  <verify>User performs the above steps with physical Arduino hardware and confirms each test passes.</verify>
  <done>All DTW recording, recognition, null rejection, and save/load tests pass with physical hardware. User types "approved" to confirm.</done>
</task>

</tasks>

<verification>
1. imu-gesture.maxpat JSON is valid and opens in MAX without errors
2. DTW recording controls send correct messages to gesture-engine.js
3. Per-gesture slot rows allow enable/disable, threshold, cooldown, delete
4. Save/Load dialogs produce and consume valid JSON gesture libraries
5. DTW match events route to dedicated outlet
6. Continuous confidence stream routes to dedicated outlet
7. Quaternion data routes to dedicated outlet
8. Hardware verification confirms end-to-end recording, matching, and persistence
</verification>

<success_criteria>
- imu-gesture.maxpat opens in MAX with DTW UI section visible
- Record/Stop buttons trigger gesture recording in gesture-engine.js
- Save/Load buttons use native file dialogs for JSON persistence
- DTW match events flow through outlet 7
- DTW confidence stream flows through outlet 8 (when enabled)
- Quaternion data flows through outlet 9
- Hardware test confirms recording, recognition, null rejection, and save/load all work
</success_criteria>

<output>
After completion, create `.planning/phases/08-custom-dtw-gesture-recognition/08-03-SUMMARY.md`
</output>
