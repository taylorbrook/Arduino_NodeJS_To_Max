---
phase: 08-custom-dtw-gesture-recognition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - firmware/imu_firmware/imu_firmware.ino
  - firmware/imu_firmware/MadgwickLocal.h
  - firmware/imu_firmware/MadgwickLocal.cpp
  - node/serial-bridge.js
autonomous: true
requirements:
  - DTW-09

must_haves:
  truths:
    - "Arduino firmware outputs 13-value CSV (9 existing + 4 quaternion) at 114Hz without breaking existing serial communication"
    - "serial-bridge.js accepts both 9-field and 13-field CSV lines and outputs quaternion data to MAX when present"
    - "Existing imu-sensor.maxpat functionality is unaffected by the firmware change"
  artifacts:
    - path: "firmware/imu_firmware/MadgwickLocal.h"
      provides: "Local Madgwick library fork with public getQuaternion() method"
      contains: "getQuaternion"
    - path: "firmware/imu_firmware/MadgwickLocal.cpp"
      provides: "Local Madgwick library implementation"
      contains: "MadgwickLocal"
    - path: "firmware/imu_firmware/imu_firmware.ino"
      provides: "13-value CSV output with quaternion fields"
      contains: "qw"
    - path: "node/serial-bridge.js"
      provides: "Flexible CSV validation accepting 9-13 fields with quaternion outlet"
      contains: "quaternion"
  key_links:
    - from: "firmware/imu_firmware/imu_firmware.ino"
      to: "firmware/imu_firmware/MadgwickLocal.h"
      via: "include directive"
      pattern: '#include "MadgwickLocal.h"'
    - from: "node/serial-bridge.js"
      to: "MAX outlets"
      via: "quaternion outlet call"
      pattern: "maxAPI\\.outlet.*quaternion"
---

<objective>
Extend the Arduino firmware to output quaternion data alongside the existing 9-value CSV, and update serial-bridge.js to parse the new 13-field format while maintaining backward compatibility.

Purpose: Quaternion data provides gimbal-lock-free orientation representation needed for robust DTW gesture matching (user-locked decision: quaternion output added in this phase).
Output: 13-value CSV firmware, local Madgwick library fork with quaternion getters, updated serial-bridge.js with flexible field validation.
</objective>

<execution_context>
@/Users/taylorbrook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/taylorbrook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-custom-dtw-gesture-recognition/08-RESEARCH.md
@firmware/imu_firmware/imu_firmware.ino
@node/serial-bridge.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fork MadgwickAHRS library locally and add quaternion getters</name>
  <files>firmware/imu_firmware/MadgwickLocal.h, firmware/imu_firmware/MadgwickLocal.cpp</files>
  <action>
Copy the MadgwickAHRS library source files from the Arduino library directory into the firmware project directory as `MadgwickLocal.h` and `MadgwickLocal.cpp`. This avoids the installed library being overwritten by Arduino IDE updates.

Find the Arduino MadgwickAHRS library files:
```bash
find ~/Documents/Arduino/libraries/Madgwick -name "MadgwickAHRS.*" 2>/dev/null || find /Users/*/Documents/Arduino/libraries/Madgwick -name "MadgwickAHRS.*" 2>/dev/null
```

If the library is not found in the user's Arduino libraries, check the bundled Arduino libraries location. The library has a `Madgwick` class with private members `q0`, `q1`, `q2`, `q3` (float).

In `MadgwickLocal.h`:
- Rename the class to `MadgwickLocal` (or keep as `Madgwick` with updated include guard) -- rename is cleaner to avoid conflicts
- Add a public method to the class:
```cpp
void getQuaternion(float *w, float *x, float *y, float *z) {
    *w = q0; *x = q1; *y = q2; *z = q3;
}
```
- Update include guards to `MadgwickLocal_h`

In `MadgwickLocal.cpp`:
- Update `#include` to reference `"MadgwickLocal.h"`
- Update class name references if renamed

Then update `firmware/imu_firmware/imu_firmware.ino`:
- Change `#include <MadgwickAHRS.h>` to `#include "MadgwickLocal.h"`
- If class was renamed, update the `Madgwick filter;` declaration to `MadgwickLocal filter;`
- After the existing `filter.updateIMU(...)` call and pitch/roll/yaw extraction, add:
```cpp
float qw, qx, qy, qz;
filter.getQuaternion(&qw, &qx, &qy, &qz);
```
- Extend the Serial.print CSV output to append 4 quaternion fields after yaw:
```cpp
Serial.print(',');
Serial.print(qw, 4); Serial.print(',');
Serial.print(qx, 4); Serial.print(',');
Serial.print(qy, 4); Serial.print(',');
Serial.println(qz, 4);  // replaces the existing Serial.println for the last field
```
  Note: The last field's `Serial.println` must be on `qz` now, not on `smoothYaw`. Change the existing `Serial.println(smoothYaw, 2)` to `Serial.print(smoothYaw, 2)` and add the quaternion fields after.
- Update the STARTUP header format string to include `qw,qx,qy,qz` in the field list

IMPORTANT: Use 4 decimal places for quaternion values (they range -1.0 to 1.0 and need precision). Keep existing 2 decimal places for the first 9 fields.
  </action>
  <verify>
Compile the firmware using arduino-cli:
```bash
arduino-cli compile --fqbn arduino:megaavr:uno2018 firmware/imu_firmware/
```
Verify compilation succeeds with no errors. Check that MadgwickLocal.h and MadgwickLocal.cpp exist in firmware/imu_firmware/.
  </verify>
  <done>Firmware compiles successfully with local Madgwick fork. getQuaternion method exposes q0-q3. CSV output includes 13 fields (9 existing + 4 quaternion).</done>
</task>

<task type="auto">
  <name>Task 2: Update serial-bridge.js to handle 13-field CSV with quaternion output</name>
  <files>node/serial-bridge.js</files>
  <action>
Update `serial-bridge.js` to accept both 9-field (legacy) and 13-field (quaternion) CSV lines and output quaternion data when present.

1. **Update CSV validation** -- find the `EXPECTED_FIELDS` constant (currently `9`) and replace with flexible validation:
```javascript
var EXPECTED_FIELDS_MIN = 9;
var EXPECTED_FIELDS_MAX = 13;
```
Update the validation check from `parts.length !== EXPECTED_FIELDS` to `parts.length < EXPECTED_FIELDS_MIN || parts.length > EXPECTED_FIELDS_MAX`.

2. **Parse quaternion fields** -- after parsing the existing 9 values (ax, ay, az, gx, gy, gz, pitch, roll, yaw), add conditional quaternion extraction:
```javascript
if (values.length >= 13) {
    var qw = values[9];
    var qx = values[10];
    var qy = values[11];
    var qz = values[12];
    maxAPI.outlet("quaternion", qw, qx, qy, qz);
}
```

3. **Add quaternion to calibrated output** -- if calibration is active and quaternion data is present, also output quaternion on the calibrated stream. Quaternion values do NOT need bias calibration (they're unit quaternions from the Madgwick filter), so pass them through unchanged:
```javascript
if (values.length >= 13) {
    maxAPI.outlet("cal_quaternion", values[9], values[10], values[11], values[12]);
}
```

Do NOT modify the existing 9-field outlet calls (accel, gyro, orientation, cal_accel, cal_gyro, cal_orientation). They must continue to work identically.
  </action>
  <verify>
Read serial-bridge.js and confirm:
1. EXPECTED_FIELDS_MIN = 9, EXPECTED_FIELDS_MAX = 13
2. Quaternion outlet call exists with conditional `values.length >= 13` guard
3. Existing 9-field outlet calls unchanged
4. No syntax errors: `node --check node/serial-bridge.js` (may need to stub max-api)
  </verify>
  <done>serial-bridge.js accepts 9-13 field CSV lines. When 13 fields are present, outputs quaternion and cal_quaternion to MAX. Existing functionality unchanged for 9-field firmware.</done>
</task>

</tasks>

<verification>
1. `arduino-cli compile --fqbn arduino:megaavr:uno2018 firmware/imu_firmware/` succeeds
2. MadgwickLocal.h contains getQuaternion method
3. imu_firmware.ino outputs 13-field CSV with qw,qx,qy,qz appended
4. serial-bridge.js validates both 9-field and 13-field lines
5. serial-bridge.js outputs quaternion data when 13 fields are present
6. Existing 9-field functionality is preserved
</verification>

<success_criteria>
- Firmware compiles and produces 13-value CSV output
- serial-bridge.js handles both 9-field and 13-field CSV without errors
- Quaternion data flows from Arduino through serial-bridge.js to MAX outlets
- No breaking changes to existing imu-sensor.maxpat functionality
</success_criteria>

<output>
After completion, create `.planning/phases/08-custom-dtw-gesture-recognition/08-01-SUMMARY.md`
</output>
